<app-main-layout (logoutClicked)="logout()">
  <div class="detail-page" [class.sidebar-open]="sidebarOpen()">
    <!-- Sidebar Component -->
    <app-course-sidebar
      [sections]="sections()"
      [currentSectionId]="sectionId()"
      [expandedSectionIds]="expandedSections()"
      [isOpen]="sidebarOpen()"
      [isLoading]="sectionsLoading()"
      (close)="onSidebarClose()"
      (sectionClick)="onSectionClick($event)"
      (sectionToggle)="onSectionToggle($event)">
    </app-course-sidebar>

    <!-- Sidebar Overlay (mobile) -->
    <div class="sidebar-overlay" [class.visible]="sidebarOpen()" (click)="toggleSidebar()"></div>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" [class.hidden]="sidebarOpen()" (click)="toggleSidebar()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="9" y1="3" x2="9" y2="21"></line>
      </svg>
      <span>Nội dung</span>
    </button>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Page Header with Breadcrumb -->
      <div class="page-header">
        <app-breadcrumb [items]="getBreadcrumbs()" [showHomeIcon]="true"></app-breadcrumb>
      </div>

      <!-- Loading State -->
      <div *ngIf="loading()" class="loading-container">
        <div class="spinner"></div>
        <p>Đang tải dữ liệu...</p>
      </div>

      <!-- Section Detail -->
      <div *ngIf="!loading() && section()" class="section-detail">
        <!-- Section Header Component -->
        <app-card variant="default" class="header-card">
          <app-section-header
            [section]="section()!"
            [course]="course()"
            [sectionIndex]="sectionIndex()"
            [isEditMode]="editModeService.editMode()"
            (edit)="onEditSection()"
            (toggleVisibility)="onToggleSectionVisibility()">
          </app-section-header>
        </app-card>

        <!-- Module List Component -->
        <app-card variant="default" class="modules-card">
          <app-module-list
            [modules]="section()!.modules || []"
            [isEditMode]="editModeService.editMode()"
            [isLoading]="modulesLoading()"
            [hasOrderChanged]="hasOrderChanged()"
            (addModule)="onAddModule()"
            (viewModule)="onViewModule($event)"
            (editModule)="onEditModule($event)"
            (deleteModule)="onDeleteModule($event)"
            (toggleModuleVisibility)="onToggleModuleVisibility($event)"
            (reorder)="onModuleReorder($event)"
            (saveOrder)="onSaveModuleOrder()">
          </app-module-list>
        </app-card>
      </div>

      <!-- Not Found -->
      <div *ngIf="!loading() && !section()" class="not-found">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="12" cy="12" r="10"/>
          <line x1="15" y1="9" x2="9" y2="15"/>
          <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <h3>Không tìm thấy chương</h3>
        <p>Chương bạn đang tìm kiếm không tồn tại hoặc đã bị xóa.</p>
        <a [routerLink]="['/teacher/courses', courseId()]" class="btn btn--primary">Quay lại khóa học</a>
      </div>
    </div>
  </div>

  <!-- Module Modal Component -->
  <app-module-modal
    [isVisible]="showModuleModal()"
    [editingModule]="editingModule()"
    [course]="course()"
    [chapters]="availableChapters()"
    [questions]="availableQuestions()"
    [questionsByChapter]="questionsByChapter()"
    [selectedChapterIds]="selectedChapterIds()"
    [selectedQuestionIds]="selectedQuestionIds()"
    [chaptersLoading]="chaptersLoading()"
    [questionsLoading]="questionsLoading()"
    [activeTab]="activeQuizTab()"
    (close)="onModuleModalClose()"
    (save)="onModuleSave($event)"
    (tabChange)="onQuizTabChange($event)"
    (chapterToggle)="onChapterToggle($event)"
    (questionToggle)="onQuestionToggle($event)"
    (openAiModal)="onOpenAiModal()">
  </app-module-modal>

  <!-- Quiz Preview Component -->
  <app-quiz-preview
    [module]="previewModule()"
    [questions]="previewQuestions()"
    [answers]="previewAnswers()"
    [currentQuestionIndex]="previewCurrentQuestion()"
    [showResult]="previewShowResult()"
    [isLoading]="previewLoading()"
    [isVisible]="showQuizPreview()"
    (close)="onQuizPreviewClose()"
    (answerSelect)="onPreviewAnswerSelect($event)"
    (fillAnswer)="onPreviewFillAnswer($event)"
    (navigate)="onPreviewNavigate($event)"
    (submit)="onPreviewSubmit()"
    (reset)="onPreviewReset()">
  </app-quiz-preview>

  <!-- AI Quiz Modal Component -->
  <app-ai-quiz-modal
    [isVisible]="showAiQuizModal()"
    [subjectName]="course()?.subjectName || ''"
    [generatedQuestions]="aiGeneratedQuestions()"
    [selectedQuestions]="aiSelectedQuestions()"
    [isLoading]="aiQuizLoading()"
    [isSaving]="aiSavingToBank()"
    (close)="onAiModalClose()"
    (generate)="onAiGenerate($event)"
    (toggleQuestion)="onAiToggleQuestion($event)"
    (selectAll)="onAiSelectAll()"
    (deselectAll)="onAiDeselectAll()"
    (saveToBank)="onAiSaveToBank()"
    (regenerate)="onAiRegenerate()">
  </app-ai-quiz-modal>
</app-main-layout>
