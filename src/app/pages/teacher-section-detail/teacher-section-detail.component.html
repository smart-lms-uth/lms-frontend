<app-main-layout (logoutClicked)="logout()">
  <div class="detail-page" [class.sidebar-open]="sidebarOpen()">
    <!-- Sidebar -->
    <aside class="course-sidebar" [class.course-sidebar--open]="sidebarOpen()">
      <div class="sidebar-header">
        <h3 class="sidebar-title">Nội dung khóa học</h3>
        <button class="sidebar-close" (click)="toggleSidebar()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      
      <div class="sidebar-content">
        <div *ngIf="sectionsLoading()" class="sidebar-loading">
          <div class="spinner-small"></div>
          <span>Đang tải...</span>
        </div>
        
        <ul class="section-list" *ngIf="!sectionsLoading() && sections().length > 0">
          <li *ngFor="let sec of sections(); let i = index" 
              class="section-item" 
              [class.section-item--expanded]="expandedSections().includes(sec.id)"
              [class.section-item--active]="sec.id === sectionId()"
              [class.section-item--hidden]="!sec.visible">
            <div class="section-header">
              <div class="section-info" (click)="goToSection(sec)">
                <span class="section-number">{{ i + 1 }}</span>
                <span class="section-title">{{ sec.title }}</span>
                <span *ngIf="!sec.visible" class="hidden-badge">Ẩn</span>
              </div>
              <button class="section-toggle-btn" (click)="toggleSectionExpand(sec.id); $event.stopPropagation()">
                <svg class="section-arrow" [class.rotated]="expandedSections().includes(sec.id)" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </button>
            </div>
            <div class="section-modules" *ngIf="expandedSections().includes(sec.id)">
              <div *ngIf="sec.modules && sec.modules.length > 0" class="sidebar-module-list">
                <div *ngFor="let module of sec.modules" class="sidebar-module-item" [class.sidebar-module-item--completed]="module.isCompleted">
                  <span class="sidebar-module-icon">
                    <svg *ngIf="module.type === 'VIDEO'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                    <svg *ngIf="module.type === 'RESOURCE'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                    <svg *ngIf="module.type === 'QUIZ'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path></svg>
                    <svg *ngIf="module.type === 'ASSIGNMENT'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
                    <svg *ngIf="module.type === 'LIVESTREAM'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
                    <svg *ngIf="module.type === 'FORUM'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                  </span>
                  <span class="sidebar-module-title">{{ module.title }}</span>
                </div>
              </div>
              <p *ngIf="!sec.modules || sec.modules.length === 0" class="sidebar-empty-modules">Chưa có module</p>
              <button class="sidebar-go-section-btn" (click)="goToSection(sec); $event.stopPropagation()">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
                Xem chi tiết
              </button>
            </div>
          </li>
        </ul>
      </div>
    </aside>

    <!-- Sidebar Overlay (mobile) -->
    <div class="sidebar-overlay" [class.visible]="sidebarOpen()" (click)="toggleSidebar()"></div>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" [class.hidden]="sidebarOpen()" (click)="toggleSidebar()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="9" y1="3" x2="9" y2="21"></line>
      </svg>
      <span>Nội dung</span>
    </button>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Page Header with Breadcrumb -->
      <div class="page-header">
        <app-breadcrumb [items]="getBreadcrumbs()" [showHomeIcon]="true"></app-breadcrumb>
      </div>

    <!-- Loading State -->
    <div *ngIf="loading()" class="loading-container">
      <div class="spinner"></div>
      <p>Đang tải dữ liệu...</p>
    </div>

    <!-- Section Detail -->
    <div *ngIf="!loading() && section()" class="section-detail">
      <!-- Header Card -->
      <app-card variant="default" class="header-card">
        <div class="section-header">
          <div class="section-header__number">{{ sectionIndex() }}</div>
          <div class="section-header__info">
            <div class="section-header__top">
              <h1 class="section-header__title">{{ section()!.title }}</h1>
              <app-badge [variant]="section()!.visible ? 'success' : 'warning'">
                {{ section()!.visible ? 'Đang hiển thị' : 'Đang ẩn' }}
              </app-badge>
            </div>
            <p class="section-header__description">{{ section()!.description || 'Không có mô tả' }}</p>
            <div class="section-header__meta">
              <span class="meta-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                </svg>
                {{ section()!.moduleCount }} module
              </span>
              <span class="meta-item" *ngIf="course()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                  <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                </svg>
                {{ course()!.subjectName }}
              </span>
            </div>
          </div>
          <div class="section-header__actions" *ngIf="editModeService.editMode()">
            <button class="btn btn--outline" (click)="editSection()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
              </svg>
              Chỉnh sửa
            </button>
            <button class="btn btn--outline" (click)="toggleVisibility()">
              <svg *ngIf="section()!.visible" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                <line x1="1" y1="1" x2="23" y2="23"/>
              </svg>
              <svg *ngIf="!section()!.visible" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
              {{ section()!.visible ? 'Ẩn' : 'Hiện' }}
            </button>
          </div>
        </div>
      </app-card>

      <!-- Modules Section -->
      <app-card variant="default" class="modules-card">
        <div class="card-header">
          <h2 class="card-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
            Danh sách Module
          </h2>
          <div class="card-header-actions" *ngIf="editModeService.editMode()">
            <button class="btn btn--primary btn--sm" (click)="addModule()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 5v14M5 12h14"/>
              </svg>
              Thêm module
            </button>
            <button *ngIf="hasModuleOrderChanged()" class="btn btn--sm btn--success" (click)="saveModuleOrder()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                <polyline points="17 21 17 13 7 13 7 21"/>
                <polyline points="7 3 7 8 15 8"/>
              </svg>
              Lưu thứ tự
            </button>
          </div>
        </div>

        <div *ngIf="modulesLoading()" class="loading-inline">
          <div class="spinner-small"></div>
          <span>Đang tải modules...</span>
        </div>

        <div *ngIf="!modulesLoading() && (!section()!.modules || section()!.modules!.length === 0)" class="empty-modules">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
          </svg>
          <p>Chưa có module nào được thêm</p>
          <button *ngIf="editModeService.editMode()" class="btn btn--primary" (click)="addModule()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 5v14M5 12h14"/>
            </svg>
            Thêm module đầu tiên
          </button>
        </div>

        <div *ngIf="!modulesLoading() && section()!.modules && section()!.modules!.length > 0" 
             class="modules-list"
             cdkDropList
             [cdkDropListDisabled]="!editModeService.editMode()"
             (cdkDropListDropped)="dropModule($event)">
          <div *ngFor="let module of section()!.modules; let i = index" 
               class="module-item" 
               [class.module-item--completed]="module.isCompleted"
               [class.module-item--hidden]="!module.visible"
               [class.edit-mode]="editModeService.editMode()"
               cdkDrag
               [cdkDragDisabled]="!editModeService.editMode()">
            <!-- Drag Handle -->
            <div class="drag-handle" *ngIf="editModeService.editMode()" cdkDragHandle>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="9" cy="5" r="1"/>
                <circle cx="9" cy="12" r="1"/>
                <circle cx="9" cy="19" r="1"/>
                <circle cx="15" cy="5" r="1"/>
                <circle cx="15" cy="12" r="1"/>
                <circle cx="15" cy="19" r="1"/>
              </svg>
            </div>
            <div class="module-item__order">{{ i + 1 }}</div>
            <div class="module-item__icon" [ngClass]="'module-item__icon--' + module.type.toLowerCase()">
              <svg *ngIf="module.type === 'VIDEO'" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
              <svg *ngIf="module.type === 'RESOURCE'" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
              <svg *ngIf="module.type === 'QUIZ'" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><path d="M12 17h.01"></path></svg>
              <svg *ngIf="module.type === 'ASSIGNMENT'" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
              <svg *ngIf="module.type === 'LIVESTREAM'" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
              <svg *ngIf="module.type === 'FORUM'" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
            </div>
            <div class="module-item__content" (click)="goToModule(module)" [class.clickable]="!editModeService.editMode()">
              <h4 class="module-item__title">
                {{ module.title }}
                <span *ngIf="!module.visible" class="hidden-badge">Ẩn</span>
              </h4>
              <div class="module-item__meta">
                <span class="module-type-badge">{{ getModuleTypeLabel(module.type) }}</span>
                <span *ngIf="module.description" class="module-description">{{ module.description }}</span>
              </div>
            </div>
            <div class="module-item__view" *ngIf="!editModeService.editMode()">
              <button class="btn btn--sm btn--ghost" (click)="goToModule(module)" title="Xem chi tiết">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </button>
            </div>
            <div class="module-item__actions" *ngIf="editModeService.editMode()">
              <button class="icon-btn" title="Chỉnh sửa" (click)="editModule(module)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
              </button>
              <button class="icon-btn" title="Ẩn/Hiện" (click)="toggleModuleVisibility(module)">
                <svg *ngIf="module.visible" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
                <svg *ngIf="!module.visible" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                  <line x1="1" y1="1" x2="23" y2="23"/>
                </svg>
              </button>
              <button class="icon-btn icon-btn--danger" title="Xóa" (click)="deleteModule(module)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </app-card>
    </div>

    <!-- Not Found -->
    <div *ngIf="!loading() && !section()" class="not-found">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/>
        <line x1="15" y1="9" x2="9" y2="15"/>
        <line x1="9" y1="9" x2="15" y2="15"/>
      </svg>
      <h3>Không tìm thấy chương</h3>
      <p>Chương bạn đang tìm kiếm không tồn tại hoặc đã bị xóa.</p>
      <a [routerLink]="['/teacher/courses', courseId()]" class="btn btn--primary">Quay lại khóa học</a>
    </div>
    </div>

    <!-- Add/Edit Module Modal -->
    <div class="modal-overlay" *ngIf="showModuleModal()" (click)="closeModuleModal()">
      <div class="modal-content" [class.modal-content--large]="isQuizType()" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3 class="modal-title">{{ editingModule() ? 'Chỉnh sửa Module' : 'Thêm Module mới' }}</h3>
          <button class="modal-close" (click)="closeModuleModal()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <!-- Basic Info -->
          <div class="form-group">
            <label class="form-label">Tiêu đề <span class="required">*</span></label>
            <input type="text" class="form-input" [(ngModel)]="newModuleTitle" placeholder="Nhập tiêu đề module">
          </div>
          <div class="form-group">
            <label class="form-label">Mô tả</label>
            <textarea class="form-input form-textarea" [(ngModel)]="newModuleDescription" placeholder="Nhập mô tả (tùy chọn)" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Loại module <span class="required">*</span></label>
            <select class="form-input form-select" [(ngModel)]="newModuleType">
              <option value="VIDEO">Video bài giảng</option>
              <option value="RESOURCE">Tài liệu</option>
              <option value="QUIZ">Trắc nghiệm</option>
              <option value="ASSIGNMENT">Bài tập</option>
              <option value="LIVESTREAM">Livestream</option>
              <option value="FORUM">Thảo luận</option>
            </select>
          </div>
          <div class="form-group" *ngIf="!isQuizType()">
            <label class="form-label">URL nội dung</label>
            <input type="text" class="form-input" [(ngModel)]="newModuleContentUrl" placeholder="Nhập URL video/tài liệu (tùy chọn)">
          </div>
          
          <!-- Grade Configuration (only for ASSIGNMENT and QUIZ) -->
          <div class="grade-config" *ngIf="isGradeableType()">
            <div class="grade-config-header">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
              </svg>
              <span>Cấu hình điểm</span>
            </div>
            <div class="grade-config-row">
              <div class="form-group form-group--half">
                <label class="form-label">Điểm tối đa</label>
                <input type="number" class="form-input" [(ngModel)]="newModuleMaxScore" placeholder="10" min="0" max="100" step="0.5">
              </div>
              <div class="form-group form-group--half">
                <label class="form-label">Trọng số (%)</label>
                <input type="number" class="form-input" [(ngModel)]="newModuleScoreWeight" placeholder="0" min="0" max="100" step="1">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Loại điểm</label>
              <select class="form-input form-select" [(ngModel)]="newModuleGradeType">
                <option [ngValue]="null">-- Chưa chọn --</option>
                <option value="PROCESS">Điểm quá trình</option>
                <option value="FINAL">Điểm kết thúc</option>
              </select>
            </div>
            <div class="form-group form-group--inline">
              <label class="checkbox-label">
                <input type="checkbox" [(ngModel)]="newModuleIsShowInGradeTable" class="checkbox-input">
                <span>Hiển thị trong bảng điểm</span>
              </label>
            </div>
          </div>

          <!-- ==================== QUIZ SETTINGS ==================== -->
          <div class="quiz-settings" *ngIf="isQuizType()">
            <div class="quiz-settings-header">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
              </svg>
              <span>Cấu hình bài trắc nghiệm</span>
            </div>

            <!-- Quiz Settings Tabs -->
            <div class="quiz-tabs">
              <button class="quiz-tab" [class.quiz-tab--active]="activeQuizTab === 'time'" (click)="setQuizTab('time')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                Thời gian
              </button>
              <button class="quiz-tab" [class.quiz-tab--active]="activeQuizTab === 'attempt'" (click)="setQuizTab('attempt')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>
                Làm bài
              </button>
              <button class="quiz-tab" [class.quiz-tab--active]="activeQuizTab === 'questions'" (click)="setQuizTab('questions')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><path d="M12 17h.01"></path></svg>
                Câu hỏi
              </button>
              <button class="quiz-tab" [class.quiz-tab--active]="activeQuizTab === 'display'" (click)="setQuizTab('display')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
                Hiển thị
              </button>
              <button class="quiz-tab" [class.quiz-tab--active]="activeQuizTab === 'review'" (click)="setQuizTab('review')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                Xem lại
              </button>
              <button class="quiz-tab" [class.quiz-tab--active]="activeQuizTab === 'security'" (click)="setQuizTab('security')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                Bảo mật
              </button>
            </div>

            <!-- Tab Content: Time -->
            <div class="quiz-tab-content" *ngIf="activeQuizTab === 'time'">
              <div class="form-row">
                <div class="form-group form-group--half">
                  <label class="form-label">Ngày mở</label>
                  <input type="datetime-local" class="form-input" [(ngModel)]="quizSettings.openDate">
                </div>
                <div class="form-group form-group--half">
                  <label class="form-label">Ngày đóng</label>
                  <input type="datetime-local" class="form-input" [(ngModel)]="quizSettings.closeDate">
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Thời gian làm bài (phút)</label>
                <input type="number" class="form-input" [(ngModel)]="quizSettings.durationMinutes" placeholder="60" min="1" max="480">
                <span class="form-hint">Thời gian tối đa sinh viên có thể làm bài</span>
              </div>
            </div>

            <!-- Tab Content: Attempt -->
            <div class="quiz-tab-content" *ngIf="activeQuizTab === 'attempt'">
              <div class="form-group">
                <label class="form-label">Số lần làm bài tối đa</label>
                <input type="number" class="form-input" [(ngModel)]="quizSettings.maxAttempts" placeholder="1" min="1" max="99">
                <span class="form-hint">Số lần sinh viên được phép làm bài</span>
              </div>
              <div class="form-group">
                <label class="form-label">Cách tính điểm</label>
                <select class="form-input form-select" [(ngModel)]="quizSettings.gradingMethod">
                  <option value="HIGHEST">Điểm cao nhất</option>
                  <option value="LATEST">Điểm lần cuối</option>
                  <option value="AVERAGE">Trung bình các lần</option>
                  <option value="FIRST">Điểm lần đầu</option>
                </select>
                <span class="form-hint">Cách tính điểm khi sinh viên làm nhiều lần</span>
              </div>
            </div>

            <!-- Tab Content: Questions -->
            <div class="quiz-tab-content" *ngIf="activeQuizTab === 'questions'">
              <!-- Selection Mode -->
              <div class="form-group">
                <label class="form-label">Cách chọn câu hỏi</label>
                <select class="form-input form-select" [(ngModel)]="quizSettings.questionSelectionMode">
                  <option value="MANUAL">Chọn thủ công từng câu</option>
                  <option value="RANDOM">Ngẫu nhiên từ ngân hàng</option>
                  <option value="MIXED">Kết hợp (bắt buộc + ngẫu nhiên)</option>
                </select>
              </div>

              <!-- Loading state -->
              <div *ngIf="chaptersLoading() || questionsLoading()" class="question-loading">
                <div class="spinner-small"></div>
                <span>Đang tải danh sách câu hỏi...</span>
              </div>

              <!-- RANDOM MODE: Chapter selection + Difficulty counts -->
              <ng-container *ngIf="quizSettings.questionSelectionMode === 'RANDOM' && !chaptersLoading()">
                <div class="form-section">
                  <h4 class="form-section-title">Chọn chương (có thể chọn nhiều)</h4>
                  <div class="chapter-select-grid">
                    <label *ngFor="let chapter of availableChapters()" class="chapter-checkbox-item">
                      <input type="checkbox" 
                             [checked]="isChapterSelected(chapter.id)"
                             (change)="toggleChapterSelection(chapter.id)">
                      <span class="chapter-name">{{ chapter.name }}</span>
                      <span class="chapter-count">({{ chapter.questionCount || 0 }} câu)</span>
                    </label>
                  </div>
                  <div class="form-hint" *ngIf="selectedChapterIds.length === 0">
                    <em>Không chọn chương = lấy từ toàn bộ ngân hàng câu hỏi</em>
                  </div>
                </div>

                <div class="form-section">
                  <h4 class="form-section-title">Số lượng câu theo độ khó</h4>
                  <div class="difficulty-inputs">
                    <div class="difficulty-input-group">
                      <label class="form-label form-label--small">Câu dễ</label>
                      <input type="number" class="form-input form-input--small" 
                             [(ngModel)]="quizSettings.randomConfig!.easyCount" 
                             placeholder="0" min="0">
                    </div>
                    <div class="difficulty-input-group">
                      <label class="form-label form-label--small">Câu trung bình</label>
                      <input type="number" class="form-input form-input--small" 
                             [(ngModel)]="quizSettings.randomConfig!.mediumCount" 
                             placeholder="0" min="0">
                    </div>
                    <div class="difficulty-input-group">
                      <label class="form-label form-label--small">Câu khó</label>
                      <input type="number" class="form-input form-input--small" 
                             [(ngModel)]="quizSettings.randomConfig!.hardCount" 
                             placeholder="0" min="0">
                    </div>
                  </div>
                  <div class="total-count-display">
                    Tổng số câu: <strong>{{ getRandomTotalCount() }}</strong>
                  </div>
                </div>
              </ng-container>

              <!-- MANUAL MODE: Question list by chapter -->
              <ng-container *ngIf="quizSettings.questionSelectionMode === 'MANUAL' && !questionsLoading()">
                <div class="form-section">
                  <h4 class="form-section-title">
                    Chọn câu hỏi 
                    <span class="selected-count">(Đã chọn: {{ selectedQuestionIds.length }})</span>
                  </h4>
                  
                  <!-- Questions without chapter -->
                  <div *ngIf="getQuestionsForChapter(0).length > 0" class="chapter-question-group">
                    <div class="chapter-group-header">
                      <span class="chapter-group-title">Câu hỏi chung (không thuộc chương)</span>
                      <span class="chapter-question-count">{{ getQuestionsForChapter(0).length }} câu</span>
                    </div>
                    <div class="question-select-list">
                      <label *ngFor="let q of getQuestionsForChapter(0)" class="question-select-item">
                        <input type="checkbox" 
                               [checked]="isQuestionSelected(q.id)"
                               (change)="toggleQuestionSelection(q.id)">
                        <div class="question-info">
                          <span class="question-content" [innerHTML]="q.content"></span>
                          <div class="question-meta">
                            <span class="badge" [ngClass]="getLevelBadgeClass(q.level)">{{ getLevelDisplayName(q.level) }}</span>
                            <span class="question-type">{{ q.type }}</span>
                          </div>
                        </div>
                      </label>
                    </div>
                  </div>

                  <!-- Questions by chapter -->
                  <div *ngFor="let chapter of availableChapters()" class="chapter-question-group">
                    <div class="chapter-group-header" *ngIf="getQuestionsForChapter(chapter.id).length > 0">
                      <span class="chapter-group-title">{{ chapter.name }}</span>
                      <span class="chapter-question-count">{{ getQuestionsForChapter(chapter.id).length }} câu</span>
                    </div>
                    <div class="question-select-list" *ngIf="getQuestionsForChapter(chapter.id).length > 0">
                      <label *ngFor="let q of getQuestionsForChapter(chapter.id)" class="question-select-item">
                        <input type="checkbox" 
                               [checked]="isQuestionSelected(q.id)"
                               (change)="toggleQuestionSelection(q.id)">
                        <div class="question-info">
                          <span class="question-content" [innerHTML]="q.content"></span>
                          <div class="question-meta">
                            <span class="badge" [ngClass]="getLevelBadgeClass(q.level)">{{ getLevelDisplayName(q.level) }}</span>
                            <span class="question-type">{{ q.type }}</span>
                          </div>
                        </div>
                      </label>
                    </div>
                  </div>

                  <div *ngIf="availableQuestions().length === 0" class="empty-questions">
                    <p>Chưa có câu hỏi trong ngân hàng đề.</p>
                  </div>
                </div>
              </ng-container>

              <!-- MIXED MODE: Required questions + Random config -->
              <ng-container *ngIf="quizSettings.questionSelectionMode === 'MIXED' && !questionsLoading()">
                <!-- Required Questions Section -->
                <div class="form-section">
                  <h4 class="form-section-title">
                    Câu hỏi bắt buộc 
                    <span class="selected-count">(Đã chọn: {{ selectedQuestionIds.length }})</span>
                  </h4>
                  <p class="form-hint">Những câu này sẽ luôn xuất hiện trong đề thi</p>
                  
                  <!-- Questions without chapter -->
                  <div *ngIf="getQuestionsForChapter(0).length > 0" class="chapter-question-group">
                    <div class="chapter-group-header">
                      <span class="chapter-group-title">Câu hỏi chung</span>
                    </div>
                    <div class="question-select-list question-select-list--compact">
                      <label *ngFor="let q of getQuestionsForChapter(0)" class="question-select-item question-select-item--compact">
                        <input type="checkbox" 
                               [checked]="isQuestionSelected(q.id)"
                               (change)="toggleQuestionSelection(q.id)">
                        <span class="question-content-short" [innerHTML]="q.content"></span>
                        <span class="badge badge--small" [ngClass]="getLevelBadgeClass(q.level)">{{ getLevelDisplayName(q.level) }}</span>
                      </label>
                    </div>
                  </div>

                  <!-- Questions by chapter -->
                  <div *ngFor="let chapter of availableChapters()" class="chapter-question-group">
                    <div class="chapter-group-header" *ngIf="getQuestionsForChapter(chapter.id).length > 0">
                      <span class="chapter-group-title">{{ chapter.name }}</span>
                    </div>
                    <div class="question-select-list question-select-list--compact" *ngIf="getQuestionsForChapter(chapter.id).length > 0">
                      <label *ngFor="let q of getQuestionsForChapter(chapter.id)" class="question-select-item question-select-item--compact">
                        <input type="checkbox" 
                               [checked]="isQuestionSelected(q.id)"
                               (change)="toggleQuestionSelection(q.id)">
                        <span class="question-content-short" [innerHTML]="q.content"></span>
                        <span class="badge badge--small" [ngClass]="getLevelBadgeClass(q.level)">{{ getLevelDisplayName(q.level) }}</span>
                      </label>
                    </div>
                  </div>
                </div>

                <!-- Random Fill Section -->
                <div class="form-section form-section--highlight">
                  <h4 class="form-section-title">Câu hỏi ngẫu nhiên bổ sung</h4>
                  <p class="form-hint">Số câu còn lại sẽ được lấy ngẫu nhiên từ ngân hàng</p>
                  
                  <div class="difficulty-inputs">
                    <div class="difficulty-input-group">
                      <label class="form-label form-label--small">Dễ</label>
                      <input type="number" class="form-input form-input--small" 
                             [(ngModel)]="quizSettings.randomConfig!.easyCount" 
                             placeholder="0" min="0">
                    </div>
                    <div class="difficulty-input-group">
                      <label class="form-label form-label--small">TB</label>
                      <input type="number" class="form-input form-input--small" 
                             [(ngModel)]="quizSettings.randomConfig!.mediumCount" 
                             placeholder="0" min="0">
                    </div>
                    <div class="difficulty-input-group">
                      <label class="form-label form-label--small">Khó</label>
                      <input type="number" class="form-input form-input--small" 
                             [(ngModel)]="quizSettings.randomConfig!.hardCount" 
                             placeholder="0" min="0">
                    </div>
                  </div>
                  <div class="total-count-display">
                    Tổng đề: <strong>{{ selectedQuestionIds.length }}</strong> bắt buộc + 
                    <strong>{{ getRandomTotalCount() }}</strong> ngẫu nhiên = 
                    <strong>{{ selectedQuestionIds.length + getRandomTotalCount() }}</strong> câu
                  </div>
                </div>
              </ng-container>

              <!-- Distribution Mode (for all modes) -->
              <div class="form-group" *ngIf="!chaptersLoading()">
                <label class="form-label">Cách phát đề</label>
                <select class="form-input form-select" [(ngModel)]="quizSettings.distributionMode">
                  <option value="SAME_FOR_ALL">Cùng bộ đề cho tất cả</option>
                  <option value="UNIQUE_PER_STUDENT">Mỗi sinh viên 1 bộ đề khác</option>
                </select>
                <span class="form-hint">Chọn cách phát đề cho sinh viên khi làm bài</span>
              </div>
            </div>

            <!-- Tab Content: Display -->
            <div class="quiz-tab-content" *ngIf="activeQuizTab === 'display'">
              <div class="form-group form-group--inline">
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="quizSettings.shuffleQuestions" class="checkbox-input">
                  <span>Đảo thứ tự câu hỏi</span>
                </label>
              </div>
              <div class="form-group form-group--inline">
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="quizSettings.shuffleAnswers" class="checkbox-input">
                  <span>Đảo thứ tự đáp án</span>
                </label>
              </div>
              <div class="form-group form-group--inline">
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="quizSettings.oneQuestionPerPage" class="checkbox-input">
                  <span>Hiển thị 1 câu/trang</span>
                </label>
              </div>
              <div class="form-group form-group--inline">
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="quizSettings.allowBackNavigation" class="checkbox-input">
                  <span>Cho phép quay lại câu trước</span>
                </label>
              </div>
              <div class="form-group form-group--inline">
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="quizSettings.showQuestionNumber" class="checkbox-input">
                  <span>Hiển thị số thứ tự câu hỏi</span>
                </label>
              </div>
              <div class="form-group form-group--inline">
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="quizSettings.showPointsPerQuestion" class="checkbox-input">
                  <span>Hiển thị điểm từng câu</span>
                </label>
              </div>
            </div>

            <!-- Tab Content: Review -->
            <div class="quiz-tab-content" *ngIf="activeQuizTab === 'review'">
              <div class="form-group form-group--inline">
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="quizSettings.showScoreImmediately" class="checkbox-input">
                  <span>Hiển thị điểm ngay sau nộp bài</span>
                </label>
              </div>
              <div class="form-group form-group--inline">
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="quizSettings.allowReview" class="checkbox-input">
                  <span>Cho phép xem lại bài làm</span>
                </label>
              </div>
              <div class="form-group form-group--inline">
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="quizSettings.showCorrectAnswers" class="checkbox-input">
                  <span>Hiển thị đáp án đúng sau nộp</span>
                </label>
              </div>
              <div class="form-group" *ngIf="quizSettings.showCorrectAnswers">
                <label class="form-label">Thời điểm được xem đáp án</label>
                <input type="datetime-local" class="form-input" [(ngModel)]="quizSettings.reviewAvailableFrom">
                <span class="form-hint">Để trống = xem ngay sau khi nộp</span>
              </div>
            </div>

            <!-- Tab Content: Security -->
            <div class="quiz-tab-content" *ngIf="activeQuizTab === 'security'">
              <div class="form-group">
                <label class="form-label">Mật khẩu truy cập</label>
                <input type="text" class="form-input" [(ngModel)]="quizSettings.accessPassword" placeholder="Để trống nếu không cần mật khẩu">
                <span class="form-hint">Sinh viên phải nhập mật khẩu để vào làm bài</span>
              </div>
              <div class="form-group form-group--inline">
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="quizSettings.requireFullscreen" class="checkbox-input">
                  <span>Yêu cầu toàn màn hình</span>
                </label>
              </div>
              <div class="form-group form-group--inline">
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="quizSettings.detectTabSwitch" class="checkbox-input">
                  <span>Phát hiện chuyển tab</span>
                </label>
              </div>
              <div class="form-group" *ngIf="quizSettings.detectTabSwitch">
                <label class="form-label">Số lần chuyển tab tối đa</label>
                <input type="number" class="form-input" [(ngModel)]="quizSettings.maxTabSwitchCount" placeholder="3" min="1" max="10">
                <span class="form-hint">Vượt quá sẽ tự động nộp bài</span>
              </div>
              <div class="form-group form-group--inline">
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="quizSettings.requireWebcam" class="checkbox-input">
                  <span>Yêu cầu bật webcam (Proctoring)</span>
                </label>
              </div>
            </div>
          </div>

          <div class="form-group form-group--inline">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="newModuleVisible" class="checkbox-input">
              <span>Hiển thị module</span>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn--outline" (click)="closeModuleModal()">Hủy</button>
          <button class="btn btn--primary btn--create" (click)="saveModule()" [disabled]="!newModuleTitle.trim()">
            {{ editingModule() ? 'Cập nhật' : 'Tạo module' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quiz Preview Modal -->
  <div class="quiz-preview-overlay" *ngIf="showQuizPreview()" (click)="closeQuizPreview()">
    <div class="quiz-preview-container" (click)="$event.stopPropagation()">
      <!-- Header -->
      <div class="quiz-preview-header">
        <div class="quiz-preview-title">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
            <path d="M12 17h.01"></path>
          </svg>
          <span>{{ previewModule()?.title }} - Xem trước</span>
        </div>
        <button class="quiz-preview-close" (click)="closeQuizPreview()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <!-- Loading -->
      <div *ngIf="previewLoading()" class="quiz-preview-loading">
        <div class="spinner"></div>
        <p>Đang tải câu hỏi...</p>
      </div>

      <!-- No Questions -->
      <div *ngIf="!previewLoading() && previewQuestions().length === 0" class="quiz-preview-empty">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
          <path d="M12 17h.01"></path>
        </svg>
        <h3>Chưa có câu hỏi</h3>
        <p>Quiz này chưa được cấu hình câu hỏi. Vui lòng bật Edit Mode để thêm câu hỏi.</p>
      </div>

      <!-- Quiz Content -->
      <div *ngIf="!previewLoading() && previewQuestions().length > 0" class="quiz-preview-content">
        <!-- Question Navigation (sidebar) -->
        <div class="quiz-nav-sidebar">
          <div class="quiz-nav-title">Câu hỏi</div>
          <div class="quiz-nav-grid">
            <button *ngFor="let qq of previewQuestions(); let i = index"
                    class="quiz-nav-item"
                    [class.active]="previewCurrentQuestion() === i"
                    [class.answered]="previewAnswers.has(qq.question.id)"
                    [class.correct]="previewShowResult() && isPreviewAnswerCorrect(qq.question.id, previewAnswers.get(qq.question.id)?.selectedOptionId || -1) === true"
                    [class.incorrect]="previewShowResult() && previewAnswers.has(qq.question.id) && isPreviewAnswerCorrect(qq.question.id, previewAnswers.get(qq.question.id)?.selectedOptionId || -1) === false"
                    (click)="goToPreviewQuestion(i)">
              {{ i + 1 }}
            </button>
          </div>
          
          <div class="quiz-nav-summary" *ngIf="!previewShowResult()">
            <span>Đã trả lời: {{ previewAnswers.size }}/{{ previewQuestions().length }}</span>
          </div>

          <!-- Result Summary -->
          <div class="quiz-result-summary" *ngIf="previewShowResult()">
            <div class="result-score">
              {{ calculatePreviewScore().score }}/{{ calculatePreviewScore().maxScore }}
            </div>
            <div class="result-stats">
              <span class="stat correct">✓ {{ calculatePreviewScore().correct }}</span>
              <span class="stat incorrect">✗ {{ calculatePreviewScore().total - calculatePreviewScore().correct }}</span>
            </div>
          </div>
        </div>

        <!-- Question Display -->
        <div class="quiz-question-area">
          <ng-container *ngIf="previewQuestions()[previewCurrentQuestion()] as currentQ">
            <div class="question-header">
              <span class="question-number">Câu {{ previewCurrentQuestion() + 1 }}</span>
              <span class="question-points">{{ currentQ.point }} điểm</span>
              <span class="question-type-badge" [ngClass]="'type-' + currentQ.question.type.toLowerCase()">
                {{ currentQ.question.type === 'SINGLE' ? 'Một đáp án' : currentQ.question.type === 'MULTI' ? 'Nhiều đáp án' : 'Tự luận' }}
              </span>
            </div>

            <div class="question-content" [innerHTML]="sanitizeHtml(currentQ.question.content)"></div>

            <div class="question-image" *ngIf="currentQ.question.imageUrl">
              <img [src]="currentQ.question.imageUrl" alt="Question image">
            </div>

            <!-- Options for SINGLE/MULTI -->
            <div class="question-options" *ngIf="currentQ.question.type !== 'FILL'">
              <label *ngFor="let option of currentQ.question.options" 
                     class="option-item"
                     [class.selected]="isPreviewOptionSelected(currentQ.question.id, option.id)"
                     [class.correct]="previewShowResult() && option.isCorrect"
                     [class.incorrect]="previewShowResult() && isPreviewOptionSelected(currentQ.question.id, option.id) && !option.isCorrect"
                     [class.disabled]="previewShowResult()">
                <input [type]="currentQ.question.type === 'SINGLE' ? 'radio' : 'checkbox'"
                       [name]="'q_' + currentQ.question.id"
                       [checked]="isPreviewOptionSelected(currentQ.question.id, option.id)"
                       (change)="selectPreviewAnswer(currentQ.question.id, option.id, currentQ.question.type === 'MULTI')"
                       [disabled]="previewShowResult()">
                <span class="option-label">{{ option.label }}</span>
                <span class="option-content" [innerHTML]="sanitizeHtml(option.content)"></span>
                <span class="option-indicator" *ngIf="previewShowResult()">
                  <svg *ngIf="option.isCorrect" class="icon-correct" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                  <svg *ngIf="isPreviewOptionSelected(currentQ.question.id, option.id) && !option.isCorrect" class="icon-incorrect" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </span>
              </label>
            </div>

            <!-- Fill Answer -->
            <div class="question-fill" *ngIf="currentQ.question.type === 'FILL'">
              <textarea class="fill-input"
                        [value]="getPreviewFillAnswer(currentQ.question.id)"
                        (input)="setPreviewFillAnswer(currentQ.question.id, $any($event.target).value)"
                        placeholder="Nhập câu trả lời của bạn..."
                        [disabled]="previewShowResult()"
                        rows="4"></textarea>
            </div>
          </ng-container>

          <!-- Navigation Buttons -->
          <div class="question-nav-buttons">
            <button class="btn btn--outline" 
                    [disabled]="previewCurrentQuestion() === 0"
                    (click)="goToPreviewQuestion(previewCurrentQuestion() - 1)">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
              Câu trước
            </button>
            
            <button *ngIf="previewCurrentQuestion() < previewQuestions().length - 1"
                    class="btn btn--primary"
                    (click)="goToPreviewQuestion(previewCurrentQuestion() + 1)">
              Câu sau
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </button>

            <button *ngIf="previewCurrentQuestion() === previewQuestions().length - 1 && !previewShowResult()"
                    class="btn btn--success"
                    (click)="submitPreviewQuiz()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Nộp bài (Xem kết quả)
            </button>

            <button *ngIf="previewShowResult()"
                    class="btn btn--outline"
                    (click)="resetPreviewQuiz()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                <path d="M3 3v5h5"></path>
              </svg>
              Làm lại
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</app-main-layout>
