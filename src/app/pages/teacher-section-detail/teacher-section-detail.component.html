<app-main-layout (logoutClicked)="logout()">
  <div class="detail-page" [class.sidebar-open]="sidebarOpen()">
    <!-- Sidebar -->
    <aside class="course-sidebar" [class.course-sidebar--open]="sidebarOpen()">
      <div class="sidebar-header">
        <h3 class="sidebar-title">Nội dung khóa học</h3>
        <button class="sidebar-close" (click)="toggleSidebar()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      
      <div class="sidebar-content">
        <div *ngIf="sectionsLoading()" class="sidebar-loading">
          <div class="spinner-small"></div>
          <span>Đang tải...</span>
        </div>
        
        <ul class="section-list" *ngIf="!sectionsLoading() && sections().length > 0">
          <li *ngFor="let sec of sections(); let i = index" 
              class="section-item" 
              [class.section-item--expanded]="expandedSections().includes(sec.id)"
              [class.section-item--active]="sec.id === sectionId()"
              [class.section-item--hidden]="!sec.visible">
            <div class="section-header">
              <div class="section-info" (click)="goToSection(sec)">
                <span class="section-number">{{ i + 1 }}</span>
                <span class="section-title">{{ sec.title }}</span>
                <span *ngIf="!sec.visible" class="hidden-badge">Ẩn</span>
              </div>
              <button class="section-toggle-btn" (click)="toggleSectionExpand(sec.id); $event.stopPropagation()">
                <svg class="section-arrow" [class.rotated]="expandedSections().includes(sec.id)" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </button>
            </div>
            <div class="section-modules" *ngIf="expandedSections().includes(sec.id)">
              <div *ngIf="sec.modules && sec.modules.length > 0" class="sidebar-module-list">
                <div *ngFor="let module of sec.modules" class="sidebar-module-item" [class.sidebar-module-item--completed]="module.isCompleted">
                  <span class="sidebar-module-icon">
                    <svg *ngIf="module.type === 'VIDEO'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                    <svg *ngIf="module.type === 'RESOURCE'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                    <svg *ngIf="module.type === 'QUIZ'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path></svg>
                    <svg *ngIf="module.type === 'ASSIGNMENT'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
                    <svg *ngIf="module.type === 'LIVESTREAM'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
                    <svg *ngIf="module.type === 'FORUM'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                  </span>
                  <span class="sidebar-module-title">{{ module.title }}</span>
                </div>
              </div>
              <p *ngIf="!sec.modules || sec.modules.length === 0" class="sidebar-empty-modules">Chưa có module</p>
              <button class="sidebar-go-section-btn" (click)="goToSection(sec); $event.stopPropagation()">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
                Xem chi tiết
              </button>
            </div>
          </li>
        </ul>
      </div>
    </aside>

    <!-- Sidebar Overlay (mobile) -->
    <div class="sidebar-overlay" [class.visible]="sidebarOpen()" (click)="toggleSidebar()"></div>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" [class.hidden]="sidebarOpen()" (click)="toggleSidebar()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="9" y1="3" x2="9" y2="21"></line>
      </svg>
      <span>Nội dung</span>
    </button>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Page Header with Breadcrumb -->
      <div class="page-header">
        <app-breadcrumb [items]="getBreadcrumbs()" [showHomeIcon]="true"></app-breadcrumb>
      </div>

    <!-- Loading State -->
    <div *ngIf="loading()" class="loading-container">
      <div class="spinner"></div>
      <p>Đang tải dữ liệu...</p>
    </div>

    <!-- Section Detail -->
    <div *ngIf="!loading() && section()" class="section-detail">
      <!-- Header Card -->
      <app-card variant="default" class="header-card">
        <div class="section-header">
          <div class="section-header__number">{{ sectionIndex() }}</div>
          <div class="section-header__info">
            <div class="section-header__top">
              <h1 class="section-header__title">{{ section()!.title }}</h1>
              <app-badge [variant]="section()!.visible ? 'success' : 'warning'">
                {{ section()!.visible ? 'Đang hiển thị' : 'Đang ẩn' }}
              </app-badge>
            </div>
            <p class="section-header__description">{{ section()!.description || 'Không có mô tả' }}</p>
            <div class="section-header__meta">
              <span class="meta-item">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                </svg>
                {{ section()!.moduleCount }} module
              </span>
              <span class="meta-item" *ngIf="course()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                  <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                </svg>
                {{ course()!.subjectName }}
              </span>
            </div>
          </div>
          <div class="section-header__actions" *ngIf="editModeService.editMode()">
            <button class="btn btn--outline" (click)="editSection()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
              </svg>
              Chỉnh sửa
            </button>
            <button class="btn btn--outline" (click)="toggleVisibility()">
              <svg *ngIf="section()!.visible" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                <line x1="1" y1="1" x2="23" y2="23"/>
              </svg>
              <svg *ngIf="!section()!.visible" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
              {{ section()!.visible ? 'Ẩn' : 'Hiện' }}
            </button>
          </div>
        </div>
      </app-card>

      <!-- Modules Section -->
      <app-card variant="default" class="modules-card">
        <div class="card-header">
          <h2 class="card-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
            Danh sách Module
          </h2>
          <div class="card-header-actions" *ngIf="editModeService.editMode()">
            <button class="btn btn--primary btn--sm" (click)="addModule()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 5v14M5 12h14"/>
              </svg>
              Thêm module
            </button>
            <button *ngIf="hasModuleOrderChanged()" class="btn btn--sm btn--success" (click)="saveModuleOrder()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                <polyline points="17 21 17 13 7 13 7 21"/>
                <polyline points="7 3 7 8 15 8"/>
              </svg>
              Lưu thứ tự
            </button>
          </div>
        </div>

        <div *ngIf="modulesLoading()" class="loading-inline">
          <div class="spinner-small"></div>
          <span>Đang tải modules...</span>
        </div>

        <div *ngIf="!modulesLoading() && (!section()!.modules || section()!.modules!.length === 0)" class="empty-modules">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
          </svg>
          <p>Chưa có module nào được thêm</p>
          <button *ngIf="editModeService.editMode()" class="btn btn--primary" (click)="addModule()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 5v14M5 12h14"/>
            </svg>
            Thêm module đầu tiên
          </button>
        </div>

        <div *ngIf="!modulesLoading() && section()!.modules && section()!.modules!.length > 0" 
             class="modules-list"
             cdkDropList
             [cdkDropListDisabled]="!editModeService.editMode()"
             (cdkDropListDropped)="dropModule($event)">
          <div *ngFor="let module of section()!.modules; let i = index" 
               class="module-item" 
               [class.module-item--completed]="module.isCompleted"
               [class.module-item--hidden]="!module.visible"
               [class.edit-mode]="editModeService.editMode()"
               cdkDrag
               [cdkDragDisabled]="!editModeService.editMode()">
            <!-- Drag Handle -->
            <div class="drag-handle" *ngIf="editModeService.editMode()" cdkDragHandle>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="9" cy="5" r="1"/>
                <circle cx="9" cy="12" r="1"/>
                <circle cx="9" cy="19" r="1"/>
                <circle cx="15" cy="5" r="1"/>
                <circle cx="15" cy="12" r="1"/>
                <circle cx="15" cy="19" r="1"/>
              </svg>
            </div>
            <div class="module-item__order">{{ i + 1 }}</div>
            <div class="module-item__icon" [ngClass]="'module-item__icon--' + module.type.toLowerCase()">
              <svg *ngIf="module.type === 'VIDEO'" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
              <svg *ngIf="module.type === 'RESOURCE'" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
              <svg *ngIf="module.type === 'QUIZ'" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><path d="M12 17h.01"></path></svg>
              <svg *ngIf="module.type === 'ASSIGNMENT'" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
              <svg *ngIf="module.type === 'LIVESTREAM'" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
              <svg *ngIf="module.type === 'FORUM'" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
            </div>
            <div class="module-item__content" (click)="goToModule(module)" [class.clickable]="!editModeService.editMode()">
              <h4 class="module-item__title">
                {{ module.title }}
                <span *ngIf="!module.visible" class="hidden-badge">Ẩn</span>
              </h4>
              <div class="module-item__meta">
                <span class="module-type-badge">{{ getModuleTypeLabel(module.type) }}</span>
                <span *ngIf="module.description" class="module-description">{{ module.description }}</span>
              </div>
            </div>
            <div class="module-item__view" *ngIf="!editModeService.editMode()">
              <button class="btn btn--sm btn--ghost" (click)="goToModule(module)" title="Xem chi tiết">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </button>
            </div>
            <div class="module-item__actions" *ngIf="editModeService.editMode()">
              <button class="icon-btn" title="Chỉnh sửa" (click)="editModule(module)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
              </button>
              <button class="icon-btn" title="Ẩn/Hiện" (click)="toggleModuleVisibility(module)">
                <svg *ngIf="module.visible" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
                <svg *ngIf="!module.visible" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                  <line x1="1" y1="1" x2="23" y2="23"/>
                </svg>
              </button>
              <button class="icon-btn icon-btn--danger" title="Xóa" (click)="deleteModule(module)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </app-card>
    </div>

    <!-- Not Found -->
    <div *ngIf="!loading() && !section()" class="not-found">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/>
        <line x1="15" y1="9" x2="9" y2="15"/>
        <line x1="9" y1="9" x2="15" y2="15"/>
      </svg>
      <h3>Không tìm thấy chương</h3>
      <p>Chương bạn đang tìm kiếm không tồn tại hoặc đã bị xóa.</p>
      <a [routerLink]="['/teacher/courses', courseId()]" class="btn btn--primary">Quay lại khóa học</a>
    </div>
    </div>

    <!-- Add/Edit Module Modal -->
    <div class="modal-overlay" *ngIf="showModuleModal()" (click)="closeModuleModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3 class="modal-title">{{ editingModule() ? 'Chỉnh sửa Module' : 'Thêm Module mới' }}</h3>
          <button class="modal-close" (click)="closeModuleModal()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Tiêu đề <span class="required">*</span></label>
            <input type="text" class="form-input" [(ngModel)]="newModuleTitle" placeholder="Nhập tiêu đề module">
          </div>
          <div class="form-group">
            <label class="form-label">Mô tả</label>
            <textarea class="form-input form-textarea" [(ngModel)]="newModuleDescription" placeholder="Nhập mô tả (tùy chọn)" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Loại module <span class="required">*</span></label>
            <select class="form-input form-select" [(ngModel)]="newModuleType">
              <option value="VIDEO">Video bài giảng</option>
              <option value="RESOURCE">Tài liệu</option>
              <option value="QUIZ">Trắc nghiệm</option>
              <option value="ASSIGNMENT">Bài tập</option>
              <option value="LIVESTREAM">Livestream</option>
              <option value="FORUM">Thảo luận</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">URL nội dung</label>
            <input type="text" class="form-input" [(ngModel)]="newModuleContentUrl" placeholder="Nhập URL video/tài liệu (tùy chọn)">
          </div>
          
          <!-- Grade Configuration (only for ASSIGNMENT and QUIZ) -->
          <div class="grade-config" *ngIf="isGradeableType()">
            <div class="grade-config-header">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
              </svg>
              <span>Cấu hình điểm</span>
            </div>
            <div class="grade-config-row">
              <div class="form-group form-group--half">
                <label class="form-label">Điểm tối đa</label>
                <input type="number" class="form-input" [(ngModel)]="newModuleMaxScore" placeholder="10" min="0" max="100" step="0.5">
              </div>
              <div class="form-group form-group--half">
                <label class="form-label">Trọng số (%)</label>
                <input type="number" class="form-input" [(ngModel)]="newModuleScoreWeight" placeholder="0" min="0" max="100" step="1">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Loại điểm</label>
              <select class="form-input form-select" [(ngModel)]="newModuleGradeType">
                <option [ngValue]="null">-- Chưa chọn --</option>
                <option value="PROCESS">Điểm quá trình</option>
                <option value="FINAL">Điểm kết thúc</option>
              </select>
            </div>
            <div class="form-group form-group--inline">
              <label class="checkbox-label">
                <input type="checkbox" [(ngModel)]="newModuleIsShowInGradeTable" class="checkbox-input">
                <span>Hiển thị trong bảng điểm</span>
              </label>
            </div>
          </div>

          <div class="form-group form-group--inline">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="newModuleVisible" class="checkbox-input">
              <span>Hiển thị module</span>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn--outline" (click)="closeModuleModal()">Hủy</button>
          <button class="btn btn--primary btn--create" (click)="saveModule()" [disabled]="!newModuleTitle.trim()">
            {{ editingModule() ? 'Cập nhật' : 'Tạo module' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</app-main-layout>
