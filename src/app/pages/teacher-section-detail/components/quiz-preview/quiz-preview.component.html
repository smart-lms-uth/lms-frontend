<div class="quiz-preview-overlay" *ngIf="isVisible" (click)="onClose()">
  <div class="quiz-preview-container" (click)="$event.stopPropagation()">
    <div class="quiz-preview-header">
      <div class="quiz-preview-title">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
          <path d="M12 17h.01"></path>
        </svg>
        <span>{{ module?.title }} - Xem trước</span>
      </div>
      <button class="quiz-preview-close" (click)="onClose()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div *ngIf="isLoading" class="quiz-preview-loading">
      <div class="spinner"></div>
      <p>Đang tải câu hỏi...</p>
    </div>

    <div *ngIf="!isLoading && questions.length === 0" class="quiz-preview-empty">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
        <path d="M12 17h.01"></path>
      </svg>
      <h3>Chưa có câu hỏi</h3>
      <p>Quiz này chưa được cấu hình câu hỏi. Vui lòng bật Edit Mode để thêm câu hỏi.</p>
    </div>

    <div *ngIf="!isLoading && questions.length > 0" class="quiz-preview-content">
      <div class="quiz-nav-sidebar">
        <div class="quiz-nav-title">Câu hỏi</div>
        <div class="quiz-nav-grid">
          <button *ngFor="let qq of questions; let i = index"
                  class="quiz-nav-item"
                  [class.active]="currentQuestionIndex === i"
                  [class.answered]="answers.has(qq.question.id)"
                  [class.correct]="showResult && isAnswerCorrect(qq.question.id, answers.get(qq.question.id)?.selectedOptionId || -1) === true"
                  [class.incorrect]="showResult && answers.has(qq.question.id) && isAnswerCorrect(qq.question.id, answers.get(qq.question.id)?.selectedOptionId || -1) === false"
                  (click)="onNavigate(i)">
            {{ i + 1 }}
          </button>
        </div>

        <div class="quiz-nav-summary" *ngIf="!showResult">
          <span>Đã trả lời: {{ answers.size }}/{{ questions.length }}</span>
        </div>

        <div class="quiz-result-summary" *ngIf="showResult">
          <div class="result-score">
            {{ calculateScore().score }}/{{ calculateScore().maxScore }}
          </div>
          <div class="result-stats">
            <span class="stat correct">✓ {{ calculateScore().correct }}</span>
            <span class="stat incorrect">✗ {{ calculateScore().total - calculateScore().correct }}</span>
          </div>
        </div>
      </div>

      <div class="quiz-question-area">
        <ng-container *ngIf="currentQuestion as cq">
          <div class="question-header">
            <span class="question-number">Câu {{ currentQuestionIndex + 1 }}</span>
            <span class="question-points">{{ cq.point }} điểm</span>
            <span class="question-type-badge" [ngClass]="'type-' + cq.question.type.toLowerCase()">
              {{ getQuestionTypeLabel(cq.question.type) }}
            </span>
          </div>

          <div class="question-content" [innerHTML]="sanitizeHtml(cq.question.content)"></div>

          <div class="question-image" *ngIf="cq.question.imageUrl">
            <img [src]="cq.question.imageUrl" alt="Question image">
          </div>

          <div class="question-options" *ngIf="cq.question.type !== 'FILL'">
            <label *ngFor="let option of cq.question.options"
                   class="option-item"
                   [class.selected]="isOptionSelected(cq.question.id, option.id)"
                   [class.correct]="showResult && option.isCorrect"
                   [class.incorrect]="showResult && isOptionSelected(cq.question.id, option.id) && !option.isCorrect"
                   [class.disabled]="showResult">
              <input [type]="cq.question.type === 'SINGLE' ? 'radio' : 'checkbox'"
                     [name]="'q_' + cq.question.id"
                     [checked]="isOptionSelected(cq.question.id, option.id)"
                     (change)="onSelectAnswer(cq.question.id, option.id, cq.question.type === 'MULTI')"
                     [disabled]="showResult">
              <span class="option-label">{{ option.label }}</span>
              <span class="option-content" [innerHTML]="sanitizeHtml(option.content)"></span>
              <span class="option-indicator" *ngIf="showResult">
                <svg *ngIf="option.isCorrect" class="icon-correct" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <svg *ngIf="isOptionSelected(cq.question.id, option.id) && !option.isCorrect" class="icon-incorrect" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </span>
            </label>
          </div>

          <div class="question-fill" *ngIf="cq.question.type === 'FILL'">
            <textarea class="fill-input"
                      [value]="getFillAnswer(cq.question.id)"
                      (input)="onFillAnswer(cq.question.id, $any($event.target).value)"
                      placeholder="Nhập câu trả lời của bạn..."
                      [disabled]="showResult"
                      rows="4"></textarea>
          </div>
        </ng-container>

        <div class="question-nav-buttons">
          <button class="btn btn--outline"
                  [disabled]="currentQuestionIndex === 0"
                  (click)="onNavigate(currentQuestionIndex - 1)">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
            Câu trước
          </button>

          <button *ngIf="currentQuestionIndex < questions.length - 1"
                  class="btn btn--primary"
                  (click)="onNavigate(currentQuestionIndex + 1)">
            Câu sau
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>

          <button *ngIf="currentQuestionIndex === questions.length - 1 && !showResult"
                  class="btn btn--success"
                  (click)="onSubmit()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            Nộp bài (Xem kết quả)
          </button>

          <button *ngIf="showResult"
                  class="btn btn--outline"
                  (click)="onReset()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
              <path d="M3 3v5h5"></path>
            </svg>
            Làm lại
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
