<app-main-layout (logoutClicked)="logout()">
  <div class="detail-page" [class.sidebar-open]="sidebarOpen()">
    <!-- Course Sidebar -->
    <aside class="course-sidebar" [class.course-sidebar--open]="sidebarOpen()">
      <div class="sidebar-header">
        <h3 class="sidebar-title">Nội dung khóa học</h3>
        <button class="sidebar-close" (click)="toggleSidebar()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      
      <div class="sidebar-content">
        <div *ngIf="sectionsLoading()" class="sidebar-loading">
          <div class="spinner-small"></div>
          <span>Đang tải...</span>
        </div>
        
        <div *ngIf="!sectionsLoading() && sections().length === 0" class="sidebar-empty">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
          </svg>
          <p>Chưa có nội dung</p>
          <button class="btn btn--primary btn--sm" (click)="addSection()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 5v14M5 12h14"/>
            </svg>
            Thêm chương
          </button>
        </div>

        <ul class="section-list" *ngIf="!sectionsLoading() && sections().length > 0">
          <li *ngFor="let section of sections(); let i = index" 
              class="section-item" 
              [class.section-item--expanded]="expandedSections().includes(section.id)"
              [class.section-item--hidden]="!section.visible">
            <div class="section-header">
              <div class="section-info" (click)="goToSectionDetail(section)">
                <span class="section-number">{{ i + 1 }}</span>
                <span class="section-title">{{ section.title }}</span>
                <span *ngIf="!section.visible" class="hidden-badge">Ẩn</span>
              </div>
              <button class="section-toggle-btn" (click)="toggleSection(section.id); $event.stopPropagation()">
                <svg class="section-arrow" [class.rotated]="expandedSections().includes(section.id)" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </button>
            </div>
            <div class="section-modules" *ngIf="expandedSections().includes(section.id)">
              <div *ngIf="section.modules && section.modules.length > 0" class="sidebar-module-list">
                <div *ngFor="let module of section.modules" 
                     class="sidebar-module-item" 
                     [class.sidebar-module-item--completed]="module.isCompleted"
                     draggable="true"
                     (dragstart)="onModuleDragStart($event, module, section)">
                  <span class="sidebar-module-icon">
                    <svg *ngIf="module.type === 'VIDEO'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                    <svg *ngIf="module.type === 'RESOURCE'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                    <svg *ngIf="module.type === 'QUIZ'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path></svg>
                    <svg *ngIf="module.type === 'ASSIGNMENT'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
                    <svg *ngIf="module.type === 'LIVESTREAM'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
                    <svg *ngIf="module.type === 'FORUM'" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                  </span>
                  <span class="sidebar-module-title">{{ module.title }}</span>
                </div>
              </div>
              <p *ngIf="!section.modules || section.modules.length === 0" class="sidebar-empty-modules">Chưa có module</p>
            </div>
          </li>
        </ul>
        
        <button *ngIf="!sectionsLoading() && sections().length > 0" class="add-section-btn" (click)="addSection()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 5v14M5 12h14"/>
          </svg>
          Thêm chương mới
        </button>
      </div>
    </aside>

    <!-- Sidebar Toggle Button (when closed) -->
    <button class="sidebar-toggle" [class.hidden]="sidebarOpen()" (click)="toggleSidebar()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="9" y1="3" x2="9" y2="21"></line>
      </svg>
      <span>Nội dung</span>
    </button>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Page Header with Breadcrumb -->
      <div class="page-header">
        <app-breadcrumb [items]="getBreadcrumbs()" [showHomeIcon]="true"></app-breadcrumb>
      </div>

      <!-- Loading State -->
      <div *ngIf="loading()" class="loading-container">
        <div class="spinner"></div>
        <p>Đang tải dữ liệu...</p>
      </div>

      <!-- Course Detail -->
      <div *ngIf="!loading() && course()" class="course-detail">
        <!-- Header Card -->
        <app-card variant="default" class="header-card">
          <div class="course-header">
            <div class="course-header__icon" [class]="'course-header__icon--' + getSubjectColor(course()!.subjectCode)">
              {{ course()!.subjectCode.substring(0, 2) }}
            </div>
            <div class="course-header__info">
              <div class="course-header__top">
                <h1 class="course-header__title">{{ course()!.subjectName }}</h1>
                <app-badge [variant]="courseService.getStatusVariant(course()!.status)">
                  {{ courseService.getStatusLabel(course()!.status) }}
                </app-badge>
              </div>
              <p class="course-header__code">{{ course()!.courseCode }}</p>
              <div class="course-header__meta">
                <span class="meta-item">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                  </svg>
                  {{ course()!.semesterName }}
                </span>
                <span class="meta-item">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                  </svg>
                  Phòng {{ course()!.room }}
                </span>
                <span class="meta-item">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                  </svg>
                  {{ course()!.credits }} tín chỉ
                </span>
              </div>
            </div>
            <div class="course-header__actions" *ngIf="editModeService.editMode()">
              <button class="btn btn--ai" (click)="editWithAI()" title="Chỉnh sửa khóa học với AI">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/>
                  <circle cx="8" cy="14" r="2"/>
                  <circle cx="16" cy="14" r="2"/>
                </svg>
                Sửa với AI
              </button>
              <button class="btn btn--outline" (click)="editCourse()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
                Chỉnh sửa
              </button>
            </div>
          </div>
        </app-card>

        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-card stat-card--primary">
            <div class="stat-card__icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
              </svg>
            </div>
            <div class="stat-card__content">
              <p class="stat-card__value">{{ course()!.currentEnrollment }}/{{ course()!.maxStudents }}</p>
              <p class="stat-card__label">Sinh viên đăng ký</p>
            </div>
          </div>
          <div class="stat-card stat-card--success">
            <div class="stat-card__icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
              </svg>
            </div>
            <div class="stat-card__content">
              <p class="stat-card__value">{{ sections().length }}</p>
              <p class="stat-card__label">Chương/Phần</p>
            </div>
          </div>
          <div class="stat-card stat-card--warning">
            <div class="stat-card__icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
              </svg>
            </div>
            <div class="stat-card__content">
              <p class="stat-card__value">{{ getTotalModules() }}</p>
              <p class="stat-card__label">Bài học</p>
            </div>
          </div>
          <div class="stat-card stat-card--secondary">
            <div class="stat-card__icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
            </div>
            <div class="stat-card__content">
              <p class="stat-card__value">{{ getEnrollmentPercent() }}%</p>
              <p class="stat-card__label">Tỉ lệ đăng ký</p>
            </div>
          </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs-container">
          <div class="tabs-nav">
            <button 
              class="tab-btn" 
              [class.tab-btn--active]="activeTab() === 'course'"
              (click)="setActiveTab('course')">
              Nội dung
            </button>
            <button 
              class="tab-btn" 
              [class.tab-btn--active]="activeTab() === 'liveclass'"
              (click)="setActiveTab('liveclass')">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="23 7 16 12 23 17 23 7"></polygon>
                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
              </svg>
              Lớp học trực tuyến
            </button>
            <button 
              class="tab-btn" 
              [class.tab-btn--active]="activeTab() === 'students'"
              (click)="setActiveTab('students')">
              Sinh viên
            </button>
            <button 
              class="tab-btn" 
              [class.tab-btn--active]="activeTab() === 'grades'"
              (click)="setActiveTab('grades')">
              Điểm số
            </button>
          </div>
        </div>

        <!-- Tab Content: Live Class -->
        <div *ngIf="activeTab() === 'liveclass'" class="tab-content">
          <app-live-class-manager 
            [courseId]="courseId()!" 
            [instructorId]="currentInstructorId()">
          </app-live-class-manager>
        </div>

        <!-- Tab Content: Course -->
        <div *ngIf="activeTab() === 'course'" class="tab-content">
          <!-- Sections Preview in main content -->
          <app-card variant="default" class="sections-card">
          <div class="card-header">
            <h2 class="card-title">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
              </svg>
              Nội dung khóa học
            </h2>
            <div class="card-header-actions">
              <button *ngIf="editModeService.editMode()" class="btn btn--sm btn--secondary" (click)="openCopyContentDialog()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                Copy từ lớp khác
              </button>
              <button *ngIf="editModeService.editMode()" class="btn btn--sm btn--primary" (click)="addSection()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 5v14M5 12h14"/>
                </svg>
                Thêm chương
              </button>
              <button *ngIf="editModeService.editMode() && hasOrderChanged()" class="btn btn--sm btn--success" (click)="saveOrder()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                  <polyline points="17 21 17 13 7 13 7 21"/>
                  <polyline points="7 3 7 8 15 8"/>
                </svg>
                Lưu thứ tự
              </button>
              <button class="btn btn--sm btn--outline" (click)="toggleSidebar()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="9" y1="3" x2="9" y2="21"></line>
                </svg>
                Mở sidebar
              </button>
            </div>
          </div>

          <div *ngIf="sectionsLoading()" class="loading-inline">
            <div class="spinner-small"></div>
            <span>Đang tải nội dung...</span>
          </div>

          <div *ngIf="!sectionsLoading() && sections().length === 0" class="empty-sections">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
            <p>Chưa có nội dung nào được thêm</p>
            <button class="btn btn--primary" (click)="addSection()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 5v14M5 12h14"/>
              </svg>
              Thêm chương đầu tiên
            </button>
          </div>

          <div *ngIf="!sectionsLoading() && sections().length > 0" 
               class="sections-preview"
               cdkDropList
               [cdkDropListDisabled]="!editModeService.editMode()"
               (cdkDropListDropped)="dropSection($event)">
            <div *ngFor="let section of sections(); let i = index" 
                 class="section-preview-item" 
                 [class.hidden-section]="!section.visible"
                 [class.edit-mode]="editModeService.editMode()"
                 cdkDrag
                 [cdkDragDisabled]="!editModeService.editMode()"
                 draggable="true"
                 (dragstart)="onSectionDragStart($event, section)">
              <!-- Drag Handle -->
              <div class="drag-handle" *ngIf="editModeService.editMode()" cdkDragHandle>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="9" cy="5" r="1"/>
                  <circle cx="9" cy="12" r="1"/>
                  <circle cx="9" cy="19" r="1"/>
                  <circle cx="15" cy="5" r="1"/>
                  <circle cx="15" cy="12" r="1"/>
                  <circle cx="15" cy="19" r="1"/>
                </svg>
              </div>
              <div class="section-preview-number">{{ i + 1 }}</div>
              <div class="section-preview-info" (click)="goToSectionDetail(section)">
                <!-- Inline editing mode -->
                <ng-container *ngIf="editingSectionId() === section.id">
                  <div class="inline-edit-wrapper" (click)="$event.stopPropagation()">
                    <input 
                      class="inline-edit-input inline-edit-title"
                      [(ngModel)]="editingTitle"
                      (keyup.enter)="finishInlineEdit(section)"
                      (keyup.escape)="cancelInlineEdit()"
                      placeholder="Tiêu đề chương"
                      #titleInput>
                    <input 
                      class="inline-edit-input inline-edit-desc"
                      [(ngModel)]="editingDescription"
                      (keyup.enter)="finishInlineEdit(section)"
                      (keyup.escape)="cancelInlineEdit()"
                      placeholder="Mô tả (tùy chọn)">
                    <div class="inline-edit-actions">
                      <button class="inline-edit-btn inline-edit-btn--save" (click)="finishInlineEdit(section)">Lưu</button>
                      <button class="inline-edit-btn inline-edit-btn--cancel" (click)="cancelInlineEdit()">Hủy</button>
                    </div>
                  </div>
                </ng-container>
                <!-- Display mode -->
                <ng-container *ngIf="editingSectionId() !== section.id">
                  <h4 
                    [class.editable]="editModeService.editMode()"
                    (click)="editModeService.editMode() ? startInlineEdit(section, $event) : null">
                    {{ section.title }}
                    <svg *ngIf="editModeService.editMode()" class="edit-hint-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                  </h4>
                  <p 
                    [class.editable]="editModeService.editMode()"
                    (click)="editModeService.editMode() ? startInlineEdit(section, $event) : null">
                    {{ section.description || 'Không có mô tả' }}
                    <svg *ngIf="editModeService.editMode()" class="edit-hint-icon" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                  </p>
                </ng-container>
                <span *ngIf="!section.visible" class="visibility-badge">Đang ẩn</span>
              </div>
              <div class="section-preview-right">
                <span class="module-count">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                  </svg>
                  {{ section.moduleCount }} module
                </span>
                <!-- Edit Mode Actions -->
                <div class="section-actions" *ngIf="editModeService.editMode()">
                  <button class="icon-btn" title="Chỉnh sửa" (click)="editSection(section); $event.stopPropagation()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                  </button>
                  <button class="icon-btn" title="Ẩn/Hiện" (click)="toggleVisibility(section); $event.stopPropagation()">
                    <svg *ngIf="section.visible" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                      <circle cx="12" cy="12" r="3"/>
                    </svg>
                    <svg *ngIf="!section.visible" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                      <line x1="1" y1="1" x2="23" y2="23"/>
                    </svg>
                  </button>
                  <button class="icon-btn icon-btn--danger" title="Xóa" (click)="deleteSection(section); $event.stopPropagation()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                  </button>
                </div>
                <!-- Toggle Expand Button -->
                <button class="expand-toggle-btn" 
                        [class.expanded]="expandedSections().includes(section.id)"
                        (click)="toggleSection(section.id); $event.stopPropagation()"
                        title="Xem danh sách module">
                  <svg class="expand-arrow" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                </button>
              </div>
              <!-- Expanded Modules List -->
              <div class="section-modules-expanded" *ngIf="expandedSections().includes(section.id)">
                <div *ngIf="section.modules && section.modules.length > 0" class="modules-grid">
                  <div *ngFor="let module of section.modules" 
                       class="module-item"
                       (click)="goToModuleDetail(section.id, module)">
                    <span class="module-item-icon">
                      <svg *ngIf="module.type === 'VIDEO'" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                      <svg *ngIf="module.type === 'RESOURCE'" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                      <svg *ngIf="module.type === 'QUIZ'" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                      <svg *ngIf="module.type === 'ASSIGNMENT'" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
                      <svg *ngIf="module.type === 'LIVESTREAM'" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
                      <svg *ngIf="module.type === 'FORUM'" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                    </span>
                    <span class="module-item-title">{{ module.title }}</span>
                    <span class="module-item-type">{{ getModuleTypeLabel(module.type) }}</span>
                  </div>
                </div>
                <p *ngIf="!section.modules || section.modules.length === 0" class="no-modules-msg">
                  Chưa có module nào trong chương này
                </p>
              </div>
            </div>
          </div>

          <!-- Add Section Button at bottom -->
          <button *ngIf="editModeService.editMode()" class="add-section-bottom-btn" (click)="addSection()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 5v14M5 12h14"/>
            </svg>
            Thêm chương mới
          </button>
        </app-card>
        </div>

        <!-- Tab Content: Students -->
        <div *ngIf="activeTab() === 'students'" class="tab-content">
          <app-teacher-course-students 
            [courseId]="courseId()!">
          </app-teacher-course-students>
        </div>

        <!-- Tab Content: Grades -->
        <div *ngIf="activeTab() === 'grades'" class="tab-content">
          <app-teacher-course-grades 
            [courseId]="courseId()!" 
            [sections]="sections">
          </app-teacher-course-grades>
        </div>
      </div>

      <!-- Not Found -->
      <div *ngIf="!loading() && !course()" class="not-found">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"/>
          <line x1="15" y1="9" x2="9" y2="15"/>
          <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <h3>Không tìm thấy lớp học phần</h3>
        <p>Lớp học phần bạn đang tìm kiếm không tồn tại hoặc đã bị xóa.</p>
        <a [routerLink]="nav.getDashboardUrl()" class="btn btn--primary">Quay lại Dashboard</a>
      </div>
    </div>

    <!-- Overlay for mobile -->
    <div class="sidebar-overlay" [class.visible]="sidebarOpen()" (click)="toggleSidebar()"></div>
  </div>

  <!-- Add Section Modal -->
  <div class="modal-overlay" *ngIf="showAddSectionModal()" (click)="cancelAddSection()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Thêm chương mới</h3>
        <button class="modal-close" (click)="cancelAddSection()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="sectionTitle">Tiêu đề chương <span class="required">*</span></label>
          <input 
            id="sectionTitle"
            type="text" 
            [(ngModel)]="newSectionTitle" 
            placeholder="Nhập tiêu đề chương..."
            class="form-input"
          />
        </div>
        <div class="form-group">
          <label for="sectionDescription">Mô tả</label>
          <textarea 
            id="sectionDescription"
            [(ngModel)]="newSectionDescription" 
            placeholder="Nhập mô tả chương (không bắt buộc)..."
            class="form-textarea"
            rows="3"
          ></textarea>
        </div>
        <div class="form-group form-group--checkbox">
          <label class="checkbox-label">
            <input 
              type="checkbox" 
              [(ngModel)]="newSectionVisible"
              class="checkbox-input"
            />
            <span class="checkbox-text">Hiển thị chương này cho sinh viên</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn--outline" (click)="cancelAddSection()">Hủy</button>
        <button class="btn btn--primary btn--create" (click)="confirmAddSection()">Tạo chương</button>
      </div>
    </div>
  </div>

  <!-- Copy Content Dialog -->
  <app-copy-content-dialog
    *ngIf="showCopyContentDialog()"
    [courseId]="courseId()!"
    [instructorId]="currentInstructorId()"
    (closed)="onCopyContentClosed($event)">
  </app-copy-content-dialog>
</app-main-layout>
