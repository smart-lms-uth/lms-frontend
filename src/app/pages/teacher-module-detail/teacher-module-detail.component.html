<app-main-layout (logoutClicked)="logout()">
  <div class="module-detail-page">
    <!-- Page Header with Breadcrumb -->
    <div class="page-header">
      <app-breadcrumb [items]="getBreadcrumbs()" [showHomeIcon]="true"></app-breadcrumb>
      
      <button class="back-btn" (click)="goBack()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
        Quay lại
      </button>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading()" class="loading-container">
      <div class="spinner"></div>
      <p>Đang tải dữ liệu...</p>
    </div>

    <!-- Main Content -->
    <div *ngIf="!loading() && module()" class="module-content">
      
      <!-- Module Header Card -->
      <app-card variant="default" class="module-header-card">
        <div class="module-header">
          <!-- Module Icon -->
          <div class="module-icon" [ngClass]="'module-icon--' + module()!.type.toLowerCase()">
            <svg *ngIf="module()!.type === 'VIDEO'" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
            <svg *ngIf="module()!.type === 'RESOURCE'" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
            <svg *ngIf="module()!.type === 'QUIZ'" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            <svg *ngIf="module()!.type === 'ASSIGNMENT'" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
              <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
            </svg>
            <svg *ngIf="module()!.type === 'LIVESTREAM'" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="23 7 16 12 23 17 23 7"></polygon>
              <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
            </svg>
            <svg *ngIf="module()!.type === 'FORUM'" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
          </div>

          <!-- Module Info -->
          <div class="module-info">
            <div class="module-info__top">
              <div class="module-info__badges">
                <app-badge [variant]="module()!.visible ? 'success' : 'warning'">
                  {{ module()!.visible ? 'Đang hiển thị' : 'Đang ẩn' }}
                </app-badge>
                <span class="module-type-badge" [ngClass]="'module-type-badge--' + module()!.type.toLowerCase()">
                  {{ getModuleTypeLabel(module()!.type) }}
                </span>
              </div>
              
              <!-- Edit Mode Actions -->
              <div class="module-actions" *ngIf="editModeService.editMode()">
                <button class="btn btn--sm btn--outline" (click)="toggleEditSettings()" *ngIf="!isEditingSettings()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                  </svg>
                  Cài đặt
                </button>
                <button class="btn btn--sm btn--outline" (click)="toggleVisibility()">
                  <svg *ngIf="module()!.visible" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                    <line x1="1" y1="1" x2="23" y2="23"/>
                  </svg>
                  <svg *ngIf="!module()!.visible" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                  </svg>
                  {{ module()!.visible ? 'Ẩn' : 'Hiện' }}
                </button>
              </div>
            </div>

            <!-- View Mode -->
            <div *ngIf="!isEditingSettings()">
              <h1 class="module-title">{{ module()!.title }}</h1>
              <div class="module-description markdown-body" *ngIf="module()!.description" [innerHTML]="module()!.description | markdown"></div>
              <p class="module-description text-muted" *ngIf="!module()!.description">Không có mô tả</p>
              
              <div class="module-meta">
                <span class="meta-item" *ngIf="module()!.estimatedDuration">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                  </svg>
                  {{ module()!.estimatedDuration }} phút
                </span>
                <span class="meta-item" *ngIf="isGradableModule()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                  </svg>
                  Điểm tối đa: 100
                </span>
                <span class="meta-item">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                  </svg>
                  Tạo: {{ formatDate(module()!.createdAt || null) }}
                </span>
              </div>
            </div>

            <!-- Edit Mode -->
            <div *ngIf="isEditingSettings()" class="module-edit-form">
              <div class="form-group">
                <label class="form-label">Tiêu đề</label>
                <input type="text" class="form-input" [(ngModel)]="editTitle" placeholder="Nhập tiêu đề module">
              </div>
              
              <div class="form-group">
                <label class="form-label">Mô tả</label>
                <textarea class="form-textarea" [(ngModel)]="editDescription" rows="3" placeholder="Nhập mô tả"></textarea>
              </div>
              
              <div class="form-group" *ngIf="module()!.type === 'VIDEO' || module()!.type === 'RESOURCE'">
                <label class="form-label">URL nội dung</label>
                <input type="text" class="form-input" [(ngModel)]="editResourceUrl" placeholder="https://...">
              </div>
              
              <!-- Extended settings for gradable modules -->
              <div class="form-row" *ngIf="isGradableModule()">
                <div class="form-group">
                  <label class="form-label">Điểm tối đa</label>
                  <input type="number" class="form-input" [(ngModel)]="editMaxScore" min="0" max="100">
                </div>
                
                <div class="form-group">
                  <label class="form-label">Trọng số (%)</label>
                  <input type="number" class="form-input" [(ngModel)]="editScoreWeight" min="0" max="100">
                </div>
                
                <div class="form-group">
                  <label class="form-label">Loại điểm</label>
                  <select class="form-select" [(ngModel)]="editGradeType">
                    <option value="">-- Chưa chọn --</option>
                    <option value="PROCESS">Điểm quá trình (QT)</option>
                    <option value="FINAL">Điểm kết thúc (KT)</option>
                  </select>
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group form-group--checkbox">
                  <label class="checkbox-label">
                    <input type="checkbox" [(ngModel)]="editVisible">
                    <span>Hiển thị cho sinh viên</span>
                  </label>
                </div>
                
                <div class="form-group form-group--checkbox" *ngIf="isGradableModule()">
                  <label class="checkbox-label">
                    <input type="checkbox" [(ngModel)]="editIsShowInGradeTable">
                    <span>Hiển thị trong bảng điểm</span>
                  </label>
                </div>
              </div>
              
              <div class="form-actions">
                <button class="btn btn--primary" (click)="saveModuleSettings()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                  </svg>
                  Lưu thay đổi
                </button>
                <button class="btn btn--outline" (click)="cancelEditSettings()">Hủy</button>
              </div>
            </div>
          </div>
        </div>
      </app-card>

      <!-- Content Preview (for VIDEO/RESOURCE) -->
      <app-card *ngIf="!isGradableModule() && module()!.resourceUrl" variant="default" class="content-preview-card">
        <h3 class="card-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>
          Xem trước nội dung
        </h3>
        <div class="content-preview">
          <div *ngIf="module()!.type === 'VIDEO'" class="video-preview">
            <div class="video-placeholder">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
              </svg>
              <p>Video: {{ module()!.resourceUrl }}</p>
            </div>
          </div>
          <div *ngIf="module()!.type === 'RESOURCE'" class="resource-link">
            <a [href]="module()!.resourceUrl" target="_blank" class="btn btn--primary">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                <polyline points="15 3 21 3 21 9"></polyline>
                <line x1="10" y1="14" x2="21" y2="3"></line>
              </svg>
              Mở tài liệu
            </a>
          </div>
        </div>
      </app-card>

      <!-- Livestream Info Section -->
      <app-card *ngIf="module()!.type === 'LIVESTREAM'" variant="default" class="livestream-info-card">
        <h3 class="card-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="23 7 16 12 23 17 23 7"></polygon>
            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
          </svg>
          Xem trước nội dung
        </h3>
        <div class="livestream-preview">
          <!-- Meeting Link -->
          <div class="livestream-meeting" *ngIf="module()!.resourceUrl">
            <a [href]="module()!.resourceUrl" target="_blank" class="meeting-link btn btn--primary btn--lg">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="23 7 16 12 23 17 23 7"></polygon>
                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
              </svg>
              Tham gia buổi học
            </a>
            <p class="meeting-url">{{ module()!.resourceUrl }}</p>
          </div>
        </div>
      </app-card>

      <!-- Instructions Section for VIDEO/RESOURCE (content modules) -->
      <app-card *ngIf="module()!.type === 'VIDEO' || module()!.type === 'RESOURCE'" variant="default" class="instructions-card">
        <div class="instructions-section">
          <div class="config-section-header">
            <h3 class="card-title">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
              </svg>
              Hướng dẫn chi tiết
            </h3>
            <div class="preview-toggle" *ngIf="editModeService.editMode()">
              <button class="toggle-btn" [class.active]="!instructionsPreviewMode()" (click)="instructionsPreviewMode.set(false)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="16 18 22 12 16 6"></polyline>
                  <polyline points="8 6 2 12 8 18"></polyline>
                </svg>
                Code
              </button>
              <button class="toggle-btn" [class.active]="instructionsPreviewMode()" (click)="instructionsPreviewMode.set(true)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
                Preview
              </button>
            </div>
          </div>
          
          <!-- Edit Mode -->
          <ng-container *ngIf="editModeService.editMode()">
            <div *ngIf="!instructionsPreviewMode()" class="instructions-editor">
              <textarea class="form-textarea markdown-input" 
                        [(ngModel)]="editInstructions" 
                        placeholder="Nhập hướng dẫn chi tiết bằng Markdown...&#10;&#10;Ví dụ:&#10;## Nội dung&#10;- Điểm chính 1&#10;- Điểm chính 2&#10;&#10;### Lưu ý&#10;Các thông tin quan trọng..."
                        rows="8"></textarea>
            </div>
            <div *ngIf="instructionsPreviewMode()" class="instructions-preview markdown-body" [innerHTML]="editInstructions | markdown"></div>
            
            <div class="form-actions">
              <button class="btn btn--primary" (click)="saveModuleSettings()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                  <polyline points="17 21 17 13 7 13 7 21"></polyline>
                  <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                Lưu hướng dẫn
              </button>
            </div>
          </ng-container>
          
          <!-- View Mode -->
          <ng-container *ngIf="!editModeService.editMode()">
            <div *ngIf="getInstructions()" class="instructions-preview markdown-body" [innerHTML]="getInstructions() | markdown"></div>
            <div *ngIf="!getInstructions()" class="instructions-empty">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
              </svg>
              <span>Chưa có hướng dẫn chi tiết</span>
            </div>
          </ng-container>
        </div>
      </app-card>

      <!-- Tabs Navigation for QUIZ/ASSIGNMENT -->
      <div *ngIf="isGradableModule()" class="module-tabs">
        <button class="module-tab" [class.active]="activeTab() === 'config'" (click)="setActiveTab('config')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
          </svg>
          Cấu hình
        </button>
        <button class="module-tab" [class.active]="activeTab() === 'submissions'" (click)="setActiveTab('submissions')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
          Bài nộp / Điểm
        </button>
      </div>

      <!-- Config Tab Content -->
      <app-card *ngIf="isGradableModule() && activeTab() === 'config'" variant="default" class="config-card">
        <h3 class="card-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
          </svg>
          Cấu hình {{ module()!.type === 'ASSIGNMENT' ? 'Bài tập' : 'Trắc nghiệm' }}
        </h3>

        <!-- Assignment Settings -->
        <div *ngIf="module()!.type === 'ASSIGNMENT'" class="config-form">
          <div class="config-section">
            <h4 class="config-section-title">Thời gian nộp bài</h4>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Hạn nộp bài</label>
                <input type="datetime-local" class="form-input" [(ngModel)]="editDueDate">
              </div>
            </div>
          </div>

          <div class="config-section">
            <h4 class="config-section-title">Quy định nộp bài</h4>
            <div class="form-row">
              <div class="form-group form-group--checkbox">
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="editAllowLateSubmission">
                  <span>Cho phép nộp trễ</span>
                </label>
              </div>
              <div class="form-group">
                <label class="form-label">Số lần nộp tối đa</label>
                <input type="number" class="form-input" [(ngModel)]="editMaxAttempts" min="1" max="10">
              </div>
            </div>
          </div>

          <!-- Instructions Section -->
          <div class="config-section instructions-section">
            <div class="config-section-header">
              <h4 class="config-section-title">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                  <polyline points="14 2 14 8 20 8"/>
                  <line x1="16" y1="13" x2="8" y2="13"/>
                  <line x1="16" y1="17" x2="8" y2="17"/>
                </svg>
                Hướng dẫn bài tập (Markdown)
              </h4>
              <div class="preview-toggle" *ngIf="editModeService.editMode()">
                <button class="toggle-btn" [class.active]="!instructionsPreviewMode()" (click)="instructionsPreviewMode.set(false)">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="16 18 22 12 16 6"></polyline>
                    <polyline points="8 6 2 12 8 18"></polyline>
                  </svg>
                  Code
                </button>
                <button class="toggle-btn" [class.active]="instructionsPreviewMode()" (click)="instructionsPreviewMode.set(true)">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                  </svg>
                  Preview
                </button>
              </div>
            </div>
            
            <!-- Edit Mode -->
            <ng-container *ngIf="editModeService.editMode()">
              <!-- Code Editor -->
              <div *ngIf="!instructionsPreviewMode()" class="instructions-editor">
                <textarea class="form-textarea markdown-input" 
                          [(ngModel)]="editInstructions" 
                          placeholder="Nhập hướng dẫn bài tập bằng Markdown...&#10;&#10;Ví dụ:&#10;## Yêu cầu&#10;1. Hoàn thành các bài tập&#10;2. Nộp file `.java`&#10;&#10;### Lưu ý&#10;- Đảm bảo code chạy được&#10;- Comment rõ ràng"
                          rows="10"></textarea>
              </div>
              <!-- Preview -->
              <div *ngIf="instructionsPreviewMode()" class="instructions-preview markdown-body" [innerHTML]="editInstructions | markdown"></div>
            </ng-container>
            
            <!-- View Mode - Always show preview -->
            <ng-container *ngIf="!editModeService.editMode()">
              <div *ngIf="getInstructions()" class="instructions-preview markdown-body" [innerHTML]="getInstructions() | markdown"></div>
              <div *ngIf="!getInstructions()" class="instructions-empty">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                  <polyline points="14 2 14 8 20 8"/>
                </svg>
                <span>Chưa có hướng dẫn bài tập</span>
              </div>
            </ng-container>
          </div>

          <div class="form-actions">
            <button class="btn btn--primary" (click)="saveModuleSettings()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
              </svg>
              Lưu cấu hình
            </button>
          </div>
        </div>

        <!-- Quiz Settings - Full Display with Edit Mode Support -->
        <div *ngIf="module()!.type === 'QUIZ'" class="quiz-config-display">
          
          <!-- Quick Stats -->
          <div class="quiz-stats-row">
            <div class="quiz-stat-item">
              <div class="quiz-stat-value">{{ quizQuestionsCount() }}</div>
              <div class="quiz-stat-label">Câu hỏi</div>
            </div>
            <div class="quiz-stat-item">
              <div class="quiz-stat-value">{{ editModeService.editMode() ? editQuizSettings.durationMinutes : (quizSettings()?.durationMinutes || 0) }}</div>
              <div class="quiz-stat-label">Phút</div>
            </div>
            <div class="quiz-stat-item">
              <div class="quiz-stat-value">{{ editModeService.editMode() ? editQuizSettings.maxAttempts : (quizSettings()?.maxAttempts || 1) }}</div>
              <div class="quiz-stat-label">Lượt làm</div>
            </div>
          </div>

          <!-- ===== EDIT MODE ===== -->
          <ng-container *ngIf="editModeService.editMode()">
            
            <!-- Time & Attempt Settings - Editable -->
            <div class="config-section">
              <h4 class="config-section-title">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                Thời gian & Số lượt làm
              </h4>
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label">Thời gian làm bài (phút)</label>
                  <input type="number" class="form-input" [(ngModel)]="editQuizSettings.durationMinutes" min="1" max="300">
                </div>
                <div class="form-group">
                  <label class="form-label">Số lượt làm tối đa</label>
                  <input type="number" class="form-input" [(ngModel)]="editQuizSettings.maxAttempts" min="1" max="10">
                </div>
                <div class="form-group">
                  <label class="form-label">Phương thức tính điểm</label>
                  <select class="form-select" [(ngModel)]="editQuizSettings.gradingMethod">
                    <option value="HIGHEST">Điểm cao nhất</option>
                    <option value="LAST">Lần làm cuối</option>
                    <option value="AVERAGE">Điểm trung bình</option>
                    <option value="FIRST">Lần làm đầu</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Question Configuration - Editable -->
            <div class="config-section">
              <h4 class="config-section-title">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                  <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                Cấu hình câu hỏi
              </h4>
              
              <!-- Question Selection Mode -->
              <div class="form-group" style="margin-bottom: 1rem;">
                <label class="form-label">Chế độ chọn câu hỏi</label>
                <select class="form-select" [(ngModel)]="editQuizSettings.questionSelectionMode" (change)="loadChapters()">
                  <option value="MANUAL">Chọn thủ công</option>
                  <option value="RANDOM">Ngẫu nhiên từ ngân hàng</option>
                  <option value="MIXED">Kết hợp</option>
                </select>
              </div>

              <!-- Random Config (when RANDOM or MIXED) -->
              <ng-container *ngIf="editQuizSettings.questionSelectionMode === 'RANDOM' || editQuizSettings.questionSelectionMode === 'MIXED'">
                <!-- Chapter Selection -->
                <div class="form-group" style="margin-bottom: 1rem;">
                  <label class="form-label">Chọn chương (để lấy câu hỏi ngẫu nhiên)</label>
                  <div class="chapter-list" *ngIf="!chaptersLoading(); else loadingChapters">
                    <div class="chapter-item" *ngFor="let chapter of availableChapters()" 
                         [class.selected]="isChapterSelected(chapter.id)"
                         (click)="toggleChapter(chapter.id)">
                      <input type="checkbox" [checked]="isChapterSelected(chapter.id)" (click)="$event.stopPropagation()">
                      <span>{{ chapter.name }}</span>
                      <span class="chapter-count">({{ chapter.questionCount || 0 }} câu)</span>
                    </div>
                    <div class="empty-chapters" *ngIf="availableChapters().length === 0">
                      Chưa có chương nào. Vui lòng thêm câu hỏi trong ngân hàng câu hỏi.
                    </div>
                  </div>
                  <ng-template #loadingChapters>
                    <div class="loading-inline">Đang tải chương...</div>
                  </ng-template>
                </div>

                <!-- Question Count by Difficulty -->
                <div class="form-grid" style="margin-bottom: 1rem;">
                  <div class="form-group">
                    <label class="form-label">Số câu dễ</label>
                    <input type="number" class="form-input" [(ngModel)]="editQuizSettings.randomConfig!.easyCount" min="0" max="100">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Số câu trung bình</label>
                    <input type="number" class="form-input" [(ngModel)]="editQuizSettings.randomConfig!.mediumCount" min="0" max="100">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Số câu khó</label>
                    <input type="number" class="form-input" [(ngModel)]="editQuizSettings.randomConfig!.hardCount" min="0" max="100">
                  </div>
                </div>

                <div class="total-questions-info">
                  <strong>Tổng số câu hỏi:</strong> {{ getTotalRandomQuestions() }} câu
                </div>
              </ng-container>

              <!-- Manual selection info -->
              <div *ngIf="editQuizSettings.questionSelectionMode === 'MANUAL'" class="manual-info">
                <p>Với chế độ chọn thủ công, bạn cần quay lại trang Section để cấu hình và chọn câu hỏi cụ thể.</p>
                <p><strong>Số câu hỏi hiện tại:</strong> {{ quizQuestionsCount() }} câu</p>
              </div>
            </div>

            <!-- Display Settings - Editable -->
            <div class="config-section">
              <h4 class="config-section-title">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
                Hiển thị
              </h4>
              <div class="form-grid form-grid--checkboxes">
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="editQuizSettings.shuffleQuestions">
                  <span>Đảo thứ tự câu hỏi</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="editQuizSettings.shuffleAnswers">
                  <span>Đảo thứ tự đáp án</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="editQuizSettings.oneQuestionPerPage">
                  <span>Mỗi trang 1 câu</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="editQuizSettings.allowBackNavigation">
                  <span>Cho phép quay lại câu trước</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="editQuizSettings.showQuestionNumber">
                  <span>Hiển thị số thứ tự câu</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="editQuizSettings.showPointsPerQuestion">
                  <span>Hiển thị điểm mỗi câu</span>
                </label>
              </div>
            </div>

            <!-- Review Settings - Editable -->
            <div class="config-section">
              <h4 class="config-section-title">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                Xem lại & Kết quả
              </h4>
              <div class="form-grid form-grid--checkboxes">
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="editQuizSettings.showScoreImmediately">
                  <span>Hiển thị điểm ngay sau khi nộp</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="editQuizSettings.showCorrectAnswers">
                  <span>Hiển thị đáp án đúng</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="editQuizSettings.allowReview">
                  <span>Cho phép xem lại bài làm</span>
                </label>
              </div>
            </div>

            <!-- Security Settings - Editable -->
            <div class="config-section">
              <h4 class="config-section-title">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                  <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
                Bảo mật
              </h4>
              <div class="form-grid form-grid--checkboxes">
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="editQuizSettings.requireFullscreen">
                  <span>Yêu cầu toàn màn hình</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="editQuizSettings.detectTabSwitch">
                  <span>Phát hiện chuyển tab</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" [(ngModel)]="editQuizSettings.requireWebcam">
                  <span>Yêu cầu webcam</span>
                </label>
              </div>
              <div class="form-group" *ngIf="editQuizSettings.detectTabSwitch" style="margin-top: 12px;">
                <label class="form-label">Số lần chuyển tab tối đa</label>
                <input type="number" class="form-input form-input--small" [(ngModel)]="editQuizSettings.maxTabSwitchCount" min="1" max="10">
              </div>
            </div>

            <!-- Instructions Section for QUIZ (Edit Mode) -->
            <div class="config-section instructions-section">
              <div class="config-section-header">
                <h4 class="config-section-title">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                  </svg>
                  Hướng dẫn làm bài (Markdown)
                </h4>
                <div class="preview-toggle">
                  <button class="toggle-btn" [class.active]="!instructionsPreviewMode()" (click)="instructionsPreviewMode.set(false)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="16 18 22 12 16 6"></polyline>
                      <polyline points="8 6 2 12 8 18"></polyline>
                    </svg>
                    Code
                  </button>
                  <button class="toggle-btn" [class.active]="instructionsPreviewMode()" (click)="instructionsPreviewMode.set(true)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                      <circle cx="12" cy="12" r="3"/>
                    </svg>
                    Preview
                  </button>
                </div>
              </div>
              <div *ngIf="!instructionsPreviewMode()" class="instructions-editor">
                <textarea class="form-textarea markdown-input" 
                          [(ngModel)]="editInstructions" 
                          placeholder="Nhập hướng dẫn làm bài bằng Markdown...&#10;&#10;Ví dụ:&#10;## Hướng dẫn&#10;- Đọc kỹ câu hỏi&#10;- Mỗi câu chỉ có 1 đáp án đúng&#10;&#10;### Lưu ý&#10;- Không được chuyển tab"
                          rows="6"></textarea>
              </div>
              <div *ngIf="instructionsPreviewMode()" class="instructions-preview markdown-body" [innerHTML]="editInstructions | markdown"></div>
            </div>

            <!-- Save Button -->
            <div class="form-actions">
              <button class="btn btn--primary" (click)="saveModuleSettings()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                  <polyline points="17 21 17 13 7 13 7 21"></polyline>
                  <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                Lưu cấu hình
              </button>
            </div>
          </ng-container>

          <!-- ===== READ-ONLY MODE ===== -->
          <ng-container *ngIf="!editModeService.editMode()">
            <!-- Time & Attempt Settings -->
            <div class="config-section">
              <h4 class="config-section-title">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                Thời gian & Số lượt làm
              </h4>
              <div class="config-grid">
                <div class="config-item">
                  <span class="config-label">Thời gian làm bài:</span>
                  <span class="config-value">{{ quizSettings()?.durationMinutes || 0 }} phút</span>
                </div>
                <div class="config-item">
                  <span class="config-label">Số lượt làm tối đa:</span>
                  <span class="config-value">{{ quizSettings()?.maxAttempts || 1 }} lượt</span>
                </div>
                <div class="config-item">
                  <span class="config-label">Phương thức tính điểm:</span>
                  <span class="config-value">{{ getGradingMethodLabel(quizSettings()?.gradingMethod) }}</span>
                </div>
              </div>
            </div>

            <!-- Question Selection -->
            <div class="config-section">
              <h4 class="config-section-title">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                  <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                Câu hỏi
              </h4>
              <div class="config-grid">
                <div class="config-item">
                  <span class="config-label">Chế độ chọn câu hỏi:</span>
                  <span class="config-value">{{ getQuestionModeLabel(quizSettings()?.questionSelectionMode) }}</span>
                </div>
                <div class="config-item">
                  <span class="config-label">Số câu trong đề:</span>
                  <span class="config-value">{{ quizQuestionsCount() }} câu</span>
                </div>
                <ng-container *ngIf="quizSettings()?.randomConfig as rc">
                  <div class="config-item" *ngIf="rc.easyCount || rc.mediumCount || rc.hardCount">
                    <span class="config-label">Phân bố độ khó:</span>
                    <span class="config-value">
                      Dễ: {{ rc.easyCount || 0 }}, TB: {{ rc.mediumCount || 0 }}, Khó: {{ rc.hardCount || 0 }}
                    </span>
                  </div>
                </ng-container>
              </div>
            </div>

          <!-- Display Settings -->
          <div class="config-section">
            <h4 class="config-section-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
              Hiển thị
            </h4>
            <div class="config-grid config-grid--checkboxes">
              <div class="config-checkbox-item" [class.active]="quizSettings()?.shuffleQuestions">
                <svg *ngIf="quizSettings()?.shuffleQuestions" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <svg *ngIf="!quizSettings()?.shuffleQuestions" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                <span>Đảo thứ tự câu hỏi</span>
              </div>
              <div class="config-checkbox-item" [class.active]="quizSettings()?.shuffleAnswers">
                <svg *ngIf="quizSettings()?.shuffleAnswers" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <svg *ngIf="!quizSettings()?.shuffleAnswers" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                <span>Đảo thứ tự đáp án</span>
              </div>
              <div class="config-checkbox-item" [class.active]="quizSettings()?.oneQuestionPerPage">
                <svg *ngIf="quizSettings()?.oneQuestionPerPage" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <svg *ngIf="!quizSettings()?.oneQuestionPerPage" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                <span>Mỗi trang 1 câu</span>
              </div>
              <div class="config-checkbox-item" [class.active]="quizSettings()?.allowBackNavigation">
                <svg *ngIf="quizSettings()?.allowBackNavigation" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <svg *ngIf="!quizSettings()?.allowBackNavigation" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                <span>Cho phép quay lại</span>
              </div>
              <div class="config-checkbox-item" [class.active]="quizSettings()?.showQuestionNumber">
                <svg *ngIf="quizSettings()?.showQuestionNumber" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <svg *ngIf="!quizSettings()?.showQuestionNumber" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                <span>Hiển thị số câu</span>
              </div>
              <div class="config-checkbox-item" [class.active]="quizSettings()?.showPointsPerQuestion">
                <svg *ngIf="quizSettings()?.showPointsPerQuestion" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <svg *ngIf="!quizSettings()?.showPointsPerQuestion" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                <span>Hiển thị điểm mỗi câu</span>
              </div>
            </div>
          </div>

          <!-- Review Settings -->
          <div class="config-section">
            <h4 class="config-section-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
              Xem lại & Kết quả
            </h4>
            <div class="config-grid config-grid--checkboxes">
              <div class="config-checkbox-item" [class.active]="quizSettings()?.showScoreImmediately">
                <svg *ngIf="quizSettings()?.showScoreImmediately" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <svg *ngIf="!quizSettings()?.showScoreImmediately" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                <span>Hiện điểm ngay</span>
              </div>
              <div class="config-checkbox-item" [class.active]="quizSettings()?.showCorrectAnswers">
                <svg *ngIf="quizSettings()?.showCorrectAnswers" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <svg *ngIf="!quizSettings()?.showCorrectAnswers" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                <span>Hiện đáp án đúng</span>
              </div>
              <div class="config-checkbox-item" [class.active]="quizSettings()?.allowReview">
                <svg *ngIf="quizSettings()?.allowReview" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <svg *ngIf="!quizSettings()?.allowReview" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                <span>Cho phép xem lại</span>
              </div>
            </div>
          </div>

          <!-- Security Settings -->
          <div class="config-section" *ngIf="quizSettings()?.requireFullscreen || quizSettings()?.detectTabSwitch || quizSettings()?.requireWebcam">
            <h4 class="config-section-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
              </svg>
              Bảo mật
            </h4>
            <div class="config-grid config-grid--checkboxes">
              <div class="config-checkbox-item" [class.active]="quizSettings()?.requireFullscreen">
                <svg *ngIf="quizSettings()?.requireFullscreen" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <svg *ngIf="!quizSettings()?.requireFullscreen" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                <span>Yêu cầu toàn màn hình</span>
              </div>
              <div class="config-checkbox-item" [class.active]="quizSettings()?.detectTabSwitch">
                <svg *ngIf="quizSettings()?.detectTabSwitch" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <svg *ngIf="!quizSettings()?.detectTabSwitch" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                <span>Phát hiện chuyển tab (tối đa {{ quizSettings()?.maxTabSwitchCount || 3 }} lần)</span>
              </div>
              <div class="config-checkbox-item" [class.active]="quizSettings()?.requireWebcam">
                <svg *ngIf="quizSettings()?.requireWebcam" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <svg *ngIf="!quizSettings()?.requireWebcam" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                <span>Yêu cầu webcam</span>
              </div>
            </div>
          </div>
          
          <!-- Instructions Section (View Mode) -->
          <div class="config-section instructions-section" *ngIf="getInstructions()">
            <h4 class="config-section-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
              </svg>
              Hướng dẫn làm bài
            </h4>
            <div class="instructions-preview markdown-body" [innerHTML]="getInstructions() | markdown"></div>
          </div>
          </ng-container>

          <!-- Action Buttons (only in read-only mode) -->
          <div class="quiz-actions" *ngIf="!editModeService.editMode()">
            <button class="btn btn--success btn--large" (click)="startQuiz()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
              </svg>
              Bắt đầu làm bài
            </button>
            <button class="btn btn--outline" (click)="previewQuiz()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
              Xem trước đề thi
            </button>
          </div>
        </div>
      </app-card>

      <!-- Submissions Section (for QUIZ/ASSIGNMENT) -->
      <app-card *ngIf="isGradableModule() && activeTab() === 'submissions'" variant="default" class="submissions-card">
        <div class="submissions-header">
          <h3 class="card-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            Danh sách sinh viên
          </h3>
          
          <!-- Stats -->
          <div class="submission-stats">
            <div class="stat-item">
              <span class="stat-value">{{ submissionStats.total }}</span>
              <span class="stat-label">Tổng</span>
            </div>
            <div class="stat-item stat-item--graded">
              <span class="stat-value">{{ submissionStats.graded }}</span>
              <span class="stat-label">Đã chấm</span>
            </div>
            <div class="stat-item stat-item--pending">
              <span class="stat-value">{{ submissionStats.notSubmitted }}</span>
              <span class="stat-label">Chưa có điểm</span>
            </div>
            <div class="stat-item stat-item--avg" *ngIf="submissionStats.averageScore !== null">
              <span class="stat-value">{{ submissionStats.averageScore }}</span>
              <span class="stat-label">Điểm TB</span>
            </div>
          </div>
        </div>

        <!-- Filter -->
        <div class="submissions-filter">
          <div class="filter-tabs">
            <button class="filter-tab" [class.active]="filterStatus() === 'all'" (click)="setFilter('all')">
              Tất cả ({{ submissionStats.total }})
            </button>
            <button class="filter-tab" *ngIf="module()?.type === 'ASSIGNMENT'" [class.active]="filterStatus() === 'SUBMITTED'" (click)="setFilter('SUBMITTED')">
              Chờ chấm ({{ submissionStats.pending }})
            </button>
            <button class="filter-tab" [class.active]="filterStatus() === 'GRADED'" (click)="setFilter('GRADED')">
              Đã chấm ({{ submissionStats.graded }})
            </button>
            <button class="filter-tab" *ngIf="module()?.type === 'ASSIGNMENT'" [class.active]="filterStatus() === 'LATE'" (click)="setFilter('LATE')">
              Nộp trễ
            </button>
            <button class="filter-tab" [class.active]="filterStatus() === 'NOT_SUBMITTED'" (click)="setFilter('NOT_SUBMITTED')">
              Chưa nộp ({{ submissionStats.notSubmitted }})
            </button>
          </div>
        </div>

        <!-- Submissions Table -->
        <div class="submissions-table-wrapper">
          <div *ngIf="submissionsLoading()" class="loading-overlay">
            <div class="spinner-small"></div>
          </div>
          
          <table class="submissions-table" *ngIf="!submissionsLoading()">
            <thead>
              <tr>
                <th class="col-index">#</th>
                <th class="col-student sortable" (click)="toggleSort('name')">
                  Sinh viên
                  <svg *ngIf="sortBy() === 'name'" class="sort-icon" [class.desc]="sortDirection() === 'desc'" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="18 15 12 9 6 15"></polyline>
                  </svg>
                </th>
                <th class="col-code">MSSV</th>
                <th class="col-file" *ngIf="module()?.type === 'ASSIGNMENT'">File nộp</th>
                <th class="col-submitted" *ngIf="module()?.type === 'ASSIGNMENT'" (click)="toggleSort('date')">
                  Thời gian nộp
                  <svg *ngIf="sortBy() === 'date'" class="sort-icon" [class.desc]="sortDirection() === 'desc'" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="18 15 12 9 6 15"></polyline>
                  </svg>
                </th>
                <th class="col-score sortable" (click)="toggleSort('score')">
                  Điểm
                  <svg *ngIf="sortBy() === 'score'" class="sort-icon" [class.desc]="sortDirection() === 'desc'" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="18 15 12 9 6 15"></polyline>
                  </svg>
                </th>
                <th class="col-feedback">Nhận xét</th>
                <th class="col-status">Trạng thái</th>
                <th class="col-actions">Thao tác</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let submission of filteredSubmissions; let i = index" 
                  class="submission-row"
                  [class.submission-row--editing]="submission.isEditing"
                  [class.submission-row--selected]="selectedSubmission()?.studentId === submission.studentId">
                <td class="col-index">{{ i + 1 }}</td>
                <td class="col-student">
                  <div class="student-info">
                    <div class="student-avatar">
                      {{ submission.fullName.charAt(0) }}
                    </div>
                    <div class="student-details">
                      <span class="student-name">{{ submission.fullName }}</span>
                      <span class="student-email">{{ submission.email }}</span>
                    </div>
                  </div>
                </td>
                <td class="col-code">{{ submission.studentCode }}</td>
                
                <!-- File nộp (chỉ cho ASSIGNMENT) -->
                <td class="col-file" *ngIf="module()?.type === 'ASSIGNMENT'">
                  <div *ngIf="submission.fileUrl" class="file-info">
                    <a (click)="viewSubmissionFile(submission)" class="file-link" [title]="submission.fileName" style="cursor: pointer;">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                      </svg>
                      <span class="file-name">{{ submission.fileName || 'Xem file' }}</span>
                    </a>
                    <button class="btn-download" 
                            (click)="downloadSubmissionFile(submission)" 
                            title="Tải xuống file">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                      </svg>
                    </button>
                    <span *ngIf="submission.attemptNumber && submission.attemptNumber > 1" class="attempt-badge" title="Lần nộp thứ {{ submission.attemptNumber }}">
                      #{{ submission.attemptNumber }}
                    </span>
                  </div>
                  <span *ngIf="!submission.fileUrl" class="no-file">-</span>
                </td>

                <!-- Thời gian nộp (chỉ cho ASSIGNMENT) -->
                <td class="col-submitted" *ngIf="module()?.type === 'ASSIGNMENT'">
                  <div *ngIf="submission.submittedAt" class="submitted-time">
                    <span class="submitted-date">{{ formatDateTime(submission.submittedAt) }}</span>
                    <span *ngIf="submission.isLate" class="late-badge">Trễ hạn</span>
                  </div>
                  <span *ngIf="!submission.submittedAt" class="not-submitted">Chưa nộp</span>
                </td>
                
                <!-- Inline editable score -->
                <td class="col-score">
                  <!-- View mode -->
                  <div *ngIf="!submission.isEditing" class="score-display" (click)="startInlineEdit(submission)">
                    <span *ngIf="submission.score !== null" class="score-value" 
                          [class.score-low]="submission.score < 50" 
                          [class.score-mid]="submission.score >= 50 && submission.score < 80" 
                          [class.score-high]="submission.score >= 80">
                      {{ submission.score }}/{{ submission.maxScore }}
                    </span>
                    <span *ngIf="submission.score === null" class="score-empty clickable">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                      </svg>
                      Chấm điểm
                    </span>
                  </div>
                  
                  <!-- Edit mode -->
                  <div *ngIf="submission.isEditing" class="score-edit">
                    <input type="number" 
                           class="score-input" 
                           [(ngModel)]="submission.editScore" 
                           [min]="0" 
                           [max]="submission.maxScore"
                           (keydown)="onGradeInputKeydown($event, submission)"
                           placeholder="0"
                           autofocus>
                    <span class="score-max">/{{ submission.maxScore }}</span>
                  </div>
                </td>
                
                <!-- Inline editable feedback -->
                <td class="col-feedback">
                  <div *ngIf="!submission.isEditing" class="feedback-display">
                    <span *ngIf="submission.feedback" class="feedback-text">{{ submission.feedback }}</span>
                    <span *ngIf="!submission.feedback" class="feedback-empty">-</span>
                  </div>
                  
                  <div *ngIf="submission.isEditing" class="feedback-edit">
                    <input type="text" 
                           class="feedback-input" 
                           [(ngModel)]="submission.editFeedback" 
                           placeholder="Nhập nhận xét..."
                           (keydown)="onGradeInputKeydown($event, submission)">
                  </div>
                </td>
                
                <td class="col-status">
                  <app-badge [variant]="getStatusBadgeVariant(submission.status)">
                    {{ getStatusLabel(submission.status) }}
                  </app-badge>
                </td>
                
                <td class="col-actions">
                  <!-- Edit mode actions -->
                  <div *ngIf="submission.isEditing" class="inline-actions">
                    <button class="btn btn--sm btn--primary" 
                            (click)="saveInlineGrade(submission)" 
                            [disabled]="savingGrade()"
                            title="Lưu điểm">
                      <svg *ngIf="!savingGrade()" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                      </svg>
                      <span *ngIf="savingGrade()" class="spinner-tiny"></span>
                    </button>
                    <button class="btn btn--sm btn--ghost" 
                            (click)="cancelInlineEdit(submission)" 
                            title="Hủy">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                      </svg>
                    </button>
                  </div>
                  
                  <!-- View mode actions -->
                  <div *ngIf="!submission.isEditing" class="view-actions">
                    <button class="btn btn--sm btn--ghost" (click)="startInlineEdit(submission)" title="Chấm điểm">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                      </svg>
                    </button>
                    <button class="btn btn--sm btn--ghost" (click)="selectSubmission(submission)" title="Xem chi tiết">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                      </svg>
                    </button>
                  </div>
                </td>
              </tr>
              
              <tr *ngIf="filteredSubmissions.length === 0">
                <td colspan="7" class="empty-row">
                  <div class="empty-state">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                      <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                      <circle cx="9" cy="7" r="4"></circle>
                      <line x1="23" y1="11" x2="17" y2="11"></line>
                    </svg>
                    <p>Không có sinh viên nào</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </app-card>

      <!-- Submission Detail Modal -->
      <div class="modal-overlay" *ngIf="selectedSubmission()" (click)="closeSubmissionDetail()">
        <div class="modal submission-detail-modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h3 class="modal-title">Chi tiết sinh viên</h3>
            <button class="modal-close" (click)="closeSubmissionDetail()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          
          <div class="modal-body">
            <!-- Student Info -->
            <div class="detail-section">
              <h4 class="detail-section-title">Thông tin sinh viên</h4>
              <div class="student-card">
                <div class="student-avatar-large">
                  {{ selectedSubmission()!.fullName.charAt(0) }}
                </div>
                <div class="student-card-info">
                  <h4>{{ selectedSubmission()!.fullName }}</h4>
                  <p class="student-code">MSSV: {{ selectedSubmission()!.studentCode }}</p>
                  <p class="student-email">{{ selectedSubmission()!.email }}</p>
                </div>
              </div>
            </div>

            <!-- Grade Info -->
            <div class="detail-section">
              <h4 class="detail-section-title">Điểm số</h4>
              <div class="grade-info">
                <div class="current-grade">
                  <span class="grade-label">Điểm hiện tại:</span>
                  <span class="grade-value" *ngIf="selectedSubmission()!.score !== null">
                    {{ selectedSubmission()!.score }}/{{ selectedSubmission()!.maxScore }}
                  </span>
                  <span class="grade-empty" *ngIf="selectedSubmission()!.score === null">Chưa có điểm</span>
                </div>
                <div class="grade-meta" *ngIf="selectedSubmission()!.gradedAt">
                  <span>Chấm lúc: {{ formatDate(selectedSubmission()!.gradedAt) }}</span>
                </div>
              </div>
            </div>

            <!-- Grading Form (Edit Mode) -->
            <div class="detail-section" *ngIf="editModeService.editMode()">
              <h4 class="detail-section-title">Chấm điểm</h4>
              <div class="grading-form">
                <div class="form-group">
                  <label class="form-label">Điểm số (0 - {{ selectedSubmission()!.maxScore }})</label>
                  <input type="number" class="form-input" [(ngModel)]="gradeScore" [min]="0" [max]="selectedSubmission()!.maxScore">
                </div>
                <div class="form-group">
                  <label class="form-label">Nhận xét</label>
                  <textarea class="form-textarea" [(ngModel)]="gradeFeedback" rows="3" placeholder="Nhập nhận xét cho sinh viên"></textarea>
                </div>
                <div class="form-actions">
                  <button class="btn btn--primary" (click)="saveGrade()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Lưu điểm
                  </button>
                </div>
              </div>
            </div>

            <!-- Feedback Display -->
            <div class="detail-section" *ngIf="selectedSubmission()!.feedback">
              <h4 class="detail-section-title">Nhận xét của giảng viên</h4>
              <div class="feedback-content">
                {{ selectedSubmission()!.feedback }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loading() && !module()" class="empty-container">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      <h3>Không tìm thấy module</h3>
      <p>Module bạn đang tìm không tồn tại hoặc đã bị xóa.</p>
      <button class="btn btn--primary" (click)="goBack()">Quay lại</button>
    </div>
  </div>
</app-main-layout>
