<app-main-layout (logoutClicked)="logout()">
  <div class="registration-page">
    <!-- Page Header -->
    <div class="page-header">
      <app-breadcrumb [items]="getBreadcrumbs()" [showHomeIcon]="true"></app-breadcrumb>
    </div>

    <!-- Success Message -->
    <div class="alert alert--success" *ngIf="showSuccessMessage()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
        <polyline points="22 4 12 14.01 9 11.01"></polyline>
      </svg>
      <span>{{ successMessage() }}</span>
    </div>

    <!-- Error Message -->
    <div class="alert alert--error" *ngIf="errorMessage()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="15" y1="9" x2="9" y2="15"></line>
        <line x1="9" y1="9" x2="15" y2="15"></line>
      </svg>
      <span>{{ errorMessage() }}</span>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading()" class="loading-container">
      <div class="spinner"></div>
      <p>Đang tải dữ liệu...</p>
    </div>

    <!-- Main Content -->
    <div *ngIf="!loading()" class="registration-content">
      <!-- Header Card -->
      <app-card variant="default" class="header-card">
        <div class="header-info">
          <div class="header-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 10v6M2 10l10-5 10 5-10 5z"></path>
              <path d="M6 12v5c3 3 9 3 12 0v-5"></path>
            </svg>
          </div>
          <div class="header-text">
            <h1>Đăng ký môn học</h1>
            <p>Chọn học kỳ và môn học để xem các lớp học phần có thể đăng ký</p>
          </div>
        </div>
        
        <!-- Stats -->
        <div class="registration-stats">
          <div class="stat-item">
            <span class="stat-value">{{ getEnrollmentCount() }}</span>
            <span class="stat-label">Môn đã đăng ký</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{{ getTotalCredits() }}</span>
            <span class="stat-label">Tổng số tín chỉ</span>
          </div>
        </div>
      </app-card>

      <div class="registration-layout">
        <!-- Left Panel - Semester & Subject Selection -->
        <div class="selection-panel">
          <!-- Semester Selection -->
          <app-card variant="default" class="selection-card">
            <h3 class="selection-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              Chọn học kỳ
            </h3>
            <div class="semester-list">
              <button 
                *ngFor="let semester of semesters()"
                class="semester-btn"
                [class.semester-btn--active]="selectedSemesterId() === semester.id"
                [class.semester-btn--current]="semester.isCurrent"
                (click)="selectSemester(semester.id)">
                <span class="semester-name">{{ semester.displayName }}</span>
                <app-badge *ngIf="semester.isCurrent" variant="primary">Hiện tại</app-badge>
              </button>
            </div>
          </app-card>

          <!-- Subject Selection -->
          <app-card variant="default" class="selection-card" *ngIf="selectedSemesterId()">
            <h3 class="selection-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
              </svg>
              Chọn môn học ({{ availableSubjects().length }} môn)
            </h3>
            
            <div *ngIf="availableSubjects().length === 0" class="empty-state">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
              </svg>
              <p>Không có môn học nào trong học kỳ này</p>
            </div>

            <div class="subject-list" *ngIf="availableSubjects().length > 0">
              <button 
                *ngFor="let subject of availableSubjects()"
                class="subject-btn"
                [class.subject-btn--active]="selectedSubjectId() === subject.id"
                (click)="selectSubject(subject.id)">
                <div class="subject-info">
                  <span class="subject-code">{{ subject.subjectCode }}</span>
                  <span class="subject-name">{{ subject.name }}</span>
                  <span class="subject-credits">{{ subject.credits }} tín chỉ</span>
                </div>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </button>
            </div>
          </app-card>
        </div>

        <!-- Right Panel - Course Classes -->
        <div class="courses-panel" *ngIf="selectedSubjectId()">
          <app-card variant="default" class="courses-card">
            <div class="courses-header">
              <h3 class="courses-title">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="3" y1="9" x2="21" y2="9"></line>
                  <line x1="9" y1="21" x2="9" y2="9"></line>
                </svg>
                Danh sách lớp học phần
                <span class="courses-count">({{ filteredCourses().length }} lớp)</span>
              </h3>
            </div>

            <div *ngIf="filteredCourses().length === 0" class="empty-state">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="9" y1="9" x2="15" y2="15"></line>
                <line x1="15" y1="9" x2="9" y2="15"></line>
              </svg>
              <p>Không có lớp học phần nào mở đăng ký</p>
            </div>

            <div class="course-list" *ngIf="filteredCourses().length > 0">
              <div 
                *ngFor="let course of filteredCourses()"
                class="course-item"
                [class.course-item--enrolled]="isEnrolled(course.id)"
                [class.course-item--full]="course.currentEnrollment >= course.maxStudents">
                
                <div class="course-main">
                  <div class="course-info">
                    <div class="course-code-row">
                      <span class="course-code">{{ course.courseCode }}</span>
                      <app-badge 
                        *ngIf="isEnrolled(course.id)" 
                        [variant]="getEnrollmentStatus(course.id) === 'ACTIVE' ? 'success' : 'warning'">
                        {{ getEnrollmentStatus(course.id) === 'ACTIVE' ? 'Đã đăng ký' : 'Chờ duyệt' }}
                      </app-badge>
                      <app-badge *ngIf="course.currentEnrollment >= course.maxStudents && !isEnrolled(course.id)" variant="danger">
                        Đã đầy
                      </app-badge>
                    </div>
                    <h4 class="course-name">{{ course.subjectName }}</h4>
                  </div>
                  
                  <div class="course-details">
                    <div class="detail-item">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                      </svg>
                      <span>{{ course.instructorName || 'Chưa có' }}</span>
                    </div>
                    <div class="detail-item">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                      </svg>
                      <span>{{ course.room || 'Chưa có' }}</span>
                    </div>
                    <div class="detail-item">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                      </svg>
                      <span>{{ course.currentEnrollment }}/{{ course.maxStudents }} sinh viên</span>
                    </div>
                    <div class="detail-item">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                      </svg>
                      <span>{{ course.credits }} tín chỉ</span>
                    </div>
                  </div>
                </div>

                <div class="course-actions">
                  <button 
                    *ngIf="!isEnrolled(course.id) && course.currentEnrollment < course.maxStudents"
                    class="btn btn--primary"
                    [disabled]="enrolling()"
                    (click)="enrollCourse(course)">
                    <svg *ngIf="!enrolling()" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <div *ngIf="enrolling()" class="spinner-small"></div>
                    {{ enrolling() ? 'Đang xử lý...' : 'Đăng ký' }}
                  </button>
                  
                  <button 
                    *ngIf="isEnrolled(course.id)"
                    class="btn btn--outline-danger"
                    (click)="cancelEnrollment(course.id)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    Hủy đăng ký
                  </button>
                </div>
              </div>
            </div>
          </app-card>
        </div>

        <!-- Placeholder when no subject selected -->
        <div class="courses-panel courses-panel--empty" *ngIf="selectedSemesterId() && !selectedSubjectId()">
          <div class="empty-placeholder">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M22 10v6M2 10l10-5 10 5-10 5z"></path>
              <path d="M6 12v5c3 3 9 3 12 0v-5"></path>
            </svg>
            <h3>Chọn môn học</h3>
            <p>Vui lòng chọn môn học từ danh sách bên trái để xem các lớp học phần</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</app-main-layout>
