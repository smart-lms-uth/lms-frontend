<app-main-layout>
  <div class="profile-page">
    <!-- Page Header -->
    <div class="page-header">
      <div class="page-header__left">
        <a routerLink="/dashboard" class="back-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
          </svg>
          Quay lại Dashboard
        </a>
        <h1 class="page-title">Hồ sơ cá nhân</h1>
      </div>
    </div>

    <!-- Loading State -->
    <div class="loading-state" *ngIf="isLoading() && !user()">
      <div class="loading-spinner"></div>
      <p>Đang tải thông tin...</p>
    </div>

    <!-- Profile Content -->
    <div class="profile-content" *ngIf="user()">
      <!-- Profile Overview Card -->
      <app-card variant="primary" class="profile-overview">
        <div class="profile-hero">
          <div class="profile-avatar-section">
            <div class="profile-avatar">
              <app-avatar 
                [src]="user()?.avatarUrl || ''"
                [name]="user()?.fullName || user()?.username || 'User'"
                size="xl"
                status="online">
              </app-avatar>
              <button class="avatar-edit-btn" title="Thay đổi ảnh đại diện">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                  <circle cx="12" cy="13" r="4"></circle>
                </svg>
              </button>
            </div>
            <div class="profile-info">
              <h2 class="profile-name">{{ user()?.fullName || user()?.username }}</h2>
              <p class="profile-email">{{ user()?.email }}</p>
              <app-badge [variant]="getRoleBadgeVariant(user()?.role || '')">
                {{ getRoleLabel(user()?.role || '') }}
              </app-badge>
            </div>
          </div>

          <div class="profile-stats">
            <div class="stat-item">
              <div class="stat-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-label">Ngày tham gia</span>
                <span class="stat-value">{{ user()?.createdAt | date:'dd/MM/yyyy' }}</span>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                  <polyline points="10 17 15 12 10 7"></polyline>
                  <line x1="15" y1="12" x2="3" y2="12"></line>
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-label">Đăng nhập qua</span>
                <span class="stat-value">{{ user()?.authProvider || 'LOCAL' }}</span>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-icon" [class.verified]="user()?.emailVerified">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-label">Trạng thái</span>
                <span class="stat-value" [class.verified]="user()?.emailVerified">
                  {{ user()?.emailVerified ? 'Đã xác thực' : 'Chưa xác thực' }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </app-card>

      <!-- Edit Profile Card -->
      <app-card variant="default" class="edit-section">
        <div card-header>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
          <span>Thông tin cá nhân</span>
        </div>

        <form [formGroup]="profileForm" (ngSubmit)="onSubmit()" class="profile-form">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">
                Họ và tên
                <span class="required">*</span>
              </label>
              <input 
                type="text" 
                class="form-input"
                [class.form-input--readonly]="!isEditing()"
                formControlName="fullName"
                [readonly]="!isEditing()">
            </div>

            <div class="form-group">
              <label class="form-label">Số điện thoại</label>
              <input 
                type="tel" 
                class="form-input"
                [class.form-input--readonly]="!isEditing()"
                formControlName="phoneNumber"
                [readonly]="!isEditing()"
                placeholder="Chưa cập nhật">
            </div>

            <div class="form-group">
              <label class="form-label">Ngày sinh</label>
              <input 
                type="date" 
                class="form-input"
                [class.form-input--readonly]="!isEditing()"
                formControlName="dateOfBirth"
                [readonly]="!isEditing()">
            </div>

            <div class="form-group">
              <label class="form-label">Địa chỉ</label>
              <input 
                type="text" 
                class="form-input"
                [class.form-input--readonly]="!isEditing()"
                formControlName="address"
                [readonly]="!isEditing()"
                placeholder="Chưa cập nhật">
            </div>

            <div class="form-group form-group--full">
              <label class="form-label">Giới thiệu bản thân</label>
              <textarea 
                class="form-input form-textarea"
                [class.form-input--readonly]="!isEditing()"
                formControlName="bio"
                rows="4"
                [readonly]="!isEditing()"
                placeholder="Viết vài dòng giới thiệu về bản thân..."></textarea>
            </div>
          </div>

          <!-- Messages -->
          <div class="message message--success" *ngIf="successMessage()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            {{ successMessage() }}
          </div>
          <div class="message message--error" *ngIf="errorMessage()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="15" y1="9" x2="9" y2="15"></line>
              <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
            {{ errorMessage() }}
          </div>

          <!-- Actions -->
          <div class="form-actions">
            <button 
              type="button" 
              class="btn btn--outline"
              (click)="toggleEdit()">
              {{ isEditing() ? 'Hủy' : 'Chỉnh sửa' }}
            </button>
            <button 
              *ngIf="isEditing()"
              type="submit" 
              class="btn btn--primary"
              [disabled]="!profileForm.valid || isSubmitting()">
              <svg *ngIf="isSubmitting()" class="btn-spinner" width="16" height="16" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="31.4 31.4" stroke-linecap="round">
                  <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s" repeatCount="indefinite"/>
                </circle>
              </svg>
              {{ isSubmitting() ? 'Đang lưu...' : 'Lưu thay đổi' }}
            </button>
          </div>
        </form>
      </app-card>

      <!-- Password Management Card -->
      <app-card>
        <div class="card-header">
          <div class="card-header__icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
          </div>
          <div class="card-header__text">
            <h2 class="card-title">Quản lý mật khẩu</h2>
            <p class="card-subtitle">{{ hasPassword() ? 'Thay đổi mật khẩu đăng nhập' : 'Thiết lập mật khẩu để đăng nhập bằng tài khoản' }}</p>
          </div>
        </div>

        <!-- Loading status -->
        <div class="loading-state" *ngIf="isLoadingPasswordStatus()">
          <div class="loading-spinner"></div>
        </div>

        <!-- Password Form -->
        <div *ngIf="!isLoadingPasswordStatus()">
          <!-- OAuth notice for users without password -->
          <div class="oauth-notice" *ngIf="!hasPassword() && user()?.authProvider === 'GOOGLE'">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            <span>Bạn đang đăng nhập qua Google. Thiết lập mật khẩu để có thể đăng nhập bằng email và mật khẩu.</span>
          </div>

          <div class="password-form">
            <!-- Current password (only for users who have password) -->
            <div class="form-group" *ngIf="hasPassword()">
              <label class="form-label">Mật khẩu hiện tại</label>
              <input 
                type="password" 
                class="form-input"
                [(ngModel)]="currentPassword"
                placeholder="Nhập mật khẩu hiện tại">
            </div>

            <div class="form-group">
              <label class="form-label">{{ hasPassword() ? 'Mật khẩu mới' : 'Mật khẩu' }}</label>
              <input 
                type="password" 
                class="form-input"
                [(ngModel)]="newPassword"
                placeholder="{{ hasPassword() ? 'Nhập mật khẩu mới' : 'Nhập mật khẩu' }}">
            </div>

            <div class="form-group">
              <label class="form-label">Xác nhận mật khẩu</label>
              <input 
                type="password" 
                class="form-input"
                [(ngModel)]="confirmPassword"
                placeholder="Nhập lại mật khẩu">
            </div>

            <!-- Messages -->
            <div class="message message--success" *ngIf="passwordSuccessMessage()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
              {{ passwordSuccessMessage() }}
            </div>
            <div class="message message--error" *ngIf="passwordErrorMessage()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
              </svg>
              {{ passwordErrorMessage() }}
            </div>

            <div class="form-actions">
              <button 
                type="button" 
                class="btn btn--primary"
                [disabled]="isSubmittingPassword()"
                (click)="hasPassword() ? onChangePassword() : onSetPassword()">
                <svg *ngIf="isSubmittingPassword()" class="btn-spinner" width="16" height="16" viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="31.4 31.4" stroke-linecap="round">
                    <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s" repeatCount="indefinite"/>
                  </circle>
                </svg>
                {{ isSubmittingPassword() ? 'Đang xử lý...' : (hasPassword() ? 'Đổi mật khẩu' : 'Thiết lập mật khẩu') }}
              </button>
            </div>
          </div>
        </div>
      </app-card>
    </div>
  </div>
</app-main-layout>
