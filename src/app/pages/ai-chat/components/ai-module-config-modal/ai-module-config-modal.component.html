<div class="modal-overlay" *ngIf="show" (click)="onClose()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal__header">
      <h2>
        <span *ngIf="moduleConfigContext?.module?.type === 'VIDEO'">üé¨ C·∫•u h√¨nh Video</span>
        <span *ngIf="moduleConfigContext?.module?.type === 'DOCUMENT'">üìÑ C·∫•u h√¨nh T√†i li·ªáu</span>
        <span *ngIf="moduleConfigContext?.module?.type === 'TEXT'">üìù C·∫•u h√¨nh VƒÉn b·∫£n</span>
        <span *ngIf="moduleConfigContext?.module?.type === 'QUIZ'">‚ùì C·∫•u h√¨nh Quiz</span>
        <span *ngIf="moduleConfigContext?.module?.type === 'ASSIGNMENT'">üìã C·∫•u h√¨nh B√†i t·∫≠p</span>
      </h2>
      <button class="modal__close" (click)="onClose()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 6 6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <div class="modal__body" *ngIf="moduleConfigContext">
      <!-- Common fields -->
      <div class="form-group">
        <label>Ti√™u ƒë·ªÅ module</label>
        <input type="text" [(ngModel)]="moduleConfigContext.module.title" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ...">
      </div>
      
      <div class="form-group">
        <label>M√¥ t·∫£</label>
        <textarea [(ngModel)]="moduleConfigContext.module.description" rows="2" placeholder="M√¥ t·∫£ module..."></textarea>
      </div>

      <!-- VIDEO Configuration -->
      <ng-container *ngIf="moduleConfigContext.module.type === 'VIDEO'">
        <div class="form-group">
          <label>üîó URL Video (YouTube, Vimeo...)</label>
          <input type="url" [(ngModel)]="moduleConfigContext.module.videoUrl" placeholder="https://youtube.com/watch?v=...">
        </div>
        <div class="form-group">
          <label>‚è±Ô∏è Th·ªùi l∆∞·ª£ng (ph√∫t)</label>
          <input type="number" [(ngModel)]="moduleConfigContext.module.videoDuration" placeholder="30" min="1">
        </div>
      </ng-container>

      <!-- DOCUMENT Configuration -->
      <ng-container *ngIf="moduleConfigContext.module.type === 'DOCUMENT'">
        <div class="form-group">
          <label>üîó URL t√†i li·ªáu</label>
          <input type="url" [(ngModel)]="moduleConfigContext.module.documentUrl" placeholder="https://drive.google.com/...">
        </div>
        <div class="form-group">
          <label>üìé Ho·∫∑c t√™n file</label>
          <input type="text" [(ngModel)]="moduleConfigContext.module.documentFile" placeholder="document.pdf">
        </div>
      </ng-container>

      <ng-container *ngIf="moduleConfigContext.module.type === 'TEXT'">
        <div class="form-group ai-chat-input">
          <label>ü§ñ AI t·∫°o n·ªôi dung</label>
          <div class="ai-input-row">
            <input 
              type="text" 
              [(ngModel)]="textAiPrompt" 
              placeholder="VD: T·∫°o b√†i gi·∫£ng v·ªÅ OOP trong Java, bao g·ªìm c√°c v√≠ d·ª• th·ª±c t·∫ø..."
              [disabled]="isGeneratingTextContent"
              (keyup.enter)="generateTextContentWithAI()">
            <button 
              class="ai-generate-btn" 
              [disabled]="!textAiPrompt.trim() || isGeneratingTextContent"
              (click)="generateTextContentWithAI()">
              <span *ngIf="!isGeneratingTextContent">‚ú® T·∫°o</span>
              <span *ngIf="isGeneratingTextContent" class="spinner-small"></span>
            </button>
          </div>
        </div>

        <div class="form-group">
          <div class="editor-header">
            <label>üìù N·ªôi dung vƒÉn b·∫£n (h·ªó tr·ª£ Markdown)</label>
            <div class="view-toggle">
              <button 
                [class.active]="textViewMode === 'edit'"
                (click)="textViewMode = 'edit'">
                Ch·ªânh s·ª≠a
              </button>
              <button 
                [class.active]="textViewMode === 'preview'"
                (click)="textViewMode = 'preview'">
                Xem tr∆∞·ªõc
              </button>
            </div>
          </div>
          <textarea 
            *ngIf="textViewMode === 'edit'"
            [(ngModel)]="moduleConfigContext.module.textContent" 
            rows="12" 
            placeholder="Nh·∫≠p n·ªôi dung b√†i h·ªçc..."></textarea>
          <div 
            *ngIf="textViewMode === 'preview'" 
            class="markdown-preview">
            <markdown [data]="moduleConfigContext.module.textContent || '*Ch∆∞a c√≥ n·ªôi dung*'"></markdown>
          </div>
        </div>
      </ng-container>

      <ng-container *ngIf="moduleConfigContext.module.type === 'QUIZ'">
        <!-- Visibility Toggle -->
        <div class="form-group toggle-group">
          <label class="toggle-label">
            <span>üëÅÔ∏è Hi·ªÉn th·ªã Quiz</span>
            <div class="toggle-switch" [class.active]="moduleConfigContext.module.isVisible !== false" (click)="moduleConfigContext.module.isVisible = !moduleConfigContext.module.isVisible">
              <div class="toggle-slider"></div>
            </div>
            <span class="toggle-status">{{ moduleConfigContext.module.isVisible !== false ? 'ƒêang hi·ªán' : 'ƒêang ·∫©n' }}</span>
          </label>
        </div>

        <!-- Time settings -->
        <div class="form-row">
          <div class="form-group">
            <label>‚è±Ô∏è Th·ªùi gian l√†m (ph√∫t)</label>
            <input type="number" [(ngModel)]="moduleConfigContext.module.quizTimeLimit" placeholder="15" min="1">
          </div>
          <div class="form-group">
            <label>üéØ ƒêi·ªÉm ƒë·∫°t (%)</label>
            <input type="number" [(ngModel)]="moduleConfigContext.module.quizPassingScore" placeholder="60" min="0" max="100">
          </div>
        </div>

        <!-- Open/Close DateTime -->
        <div class="form-row">
          <div class="form-group">
            <label>üîì Th·ªùi gian m·ªü</label>
            <input type="datetime-local" [(ngModel)]="moduleConfigContext.module.quizOpenTime">
          </div>
          <div class="form-group">
            <label>üîí Th·ªùi gian ƒë√≥ng</label>
            <input type="datetime-local" [(ngModel)]="moduleConfigContext.module.quizCloseTime">
          </div>
        </div>

        <!-- Additional settings -->
        <div class="form-row">
          <div class="form-group">
            <label>üîÑ S·ªë l·∫ßn l√†m l·∫°i</label>
            <input type="number" [(ngModel)]="moduleConfigContext.module.quizMaxAttempts" placeholder="1" min="1">
          </div>
          <div class="form-group">
            <label>üé≤ Tr·ªôn c√¢u h·ªèi</label>
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" [(ngModel)]="moduleConfigContext.module.quizShuffleQuestions">
                <span>Tr·ªôn th·ª© t·ª±</span>
              </label>
            </div>
          </div>
        </div>

        <!-- AI Chat ƒë·ªÉ t·∫°o c√¢u h·ªèi -->
        <div class="quiz-ai-chat">
          <div class="quiz-ai-chat__header">
            <span>ü§ñ T·∫°o c√¢u h·ªèi b·∫±ng AI</span>
          </div>
          <div class="quiz-ai-chat__input">
            <input 
              type="text" 
              [(ngModel)]="quizAiPrompt" 
              (keydown.enter)="generateQuizQuestionsWithAI()"
              placeholder="VD: T·∫°o 5 c√¢u h·ªèi v·ªÅ v√≤ng l·∫∑p trong Python..."
              [disabled]="isGeneratingQuizQuestions">
            <button 
              class="quiz-ai-chat__btn" 
              (click)="generateQuizQuestionsWithAI()"
              [disabled]="!quizAiPrompt.trim() || isGeneratingQuizQuestions">
              <svg *ngIf="!isGeneratingQuizQuestions" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 8V4H8"/>
                <rect width="16" height="12" x="4" y="8" rx="2"/>
                <path d="M2 14h2"/>
                <path d="M20 14h2"/>
                <path d="M15 13v2"/>
                <path d="M9 13v2"/>
              </svg>
              <div *ngIf="isGeneratingQuizQuestions" class="spinner-small"></div>
              {{ isGeneratingQuizQuestions ? 'ƒêang t·∫°o...' : 'T·∫°o' }}
            </button>
          </div>
          <div class="quiz-ai-chat__suggestions">
            <button (click)="quizAiPrompt = 'T·∫°o 5 c√¢u h·ªèi d·ªÖ v·ªÅ ' + moduleConfigContext.module.title">5 c√¢u d·ªÖ</button>
            <button (click)="quizAiPrompt = 'T·∫°o 5 c√¢u h·ªèi kh√≥ v·ªÅ ' + moduleConfigContext.module.title">5 c√¢u kh√≥</button>
            <button (click)="quizAiPrompt = 'T·∫°o 3 c√¢u h·ªèi th·ª±c h√†nh v·ªÅ ' + moduleConfigContext.module.title">3 c√¢u th·ª±c h√†nh</button>
          </div>
        </div>

        <div class="form-group">
          <div class="form-header">
            <label>üìù C√¢u h·ªèi ({{ moduleConfigContext.module.quizQuestions?.length || 0 }})</label>
            <button class="add-btn" (click)="addQuizQuestionToModule()">+ Th√™m th·ªß c√¥ng</button>
          </div>
          
          <div class="quiz-questions-list">
            <div class="quiz-question-item" *ngFor="let q of moduleConfigContext.module.quizQuestions; let qi = index; trackBy: trackByIndex">
              <div class="quiz-question-header">
                <span>C√¢u {{ qi + 1 }}</span>
                <button class="icon-btn icon-btn--danger" (click)="removeQuizQuestionFromModule(qi)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 6 6 18M6 6l12 12"/>
                  </svg>
                </button>
              </div>
              <input type="text" [(ngModel)]="q.content" placeholder="Nh·∫≠p c√¢u h·ªèi..." class="full-input">
              <div class="quiz-options">
                <div class="quiz-option-input" *ngFor="let opt of q.options; let oi = index">
                  <input type="radio" [name]="'correct-' + qi" [checked]="opt.isCorrect" (change)="setCorrectOption(q, oi)">
                  <input type="text" [(ngModel)]="opt.content" [placeholder]="'ƒê√°p √°n ' + getOptionLetter(oi)">
                </div>
              </div>
            </div>
          </div>
        </div>
      </ng-container>

      <!-- ASSIGNMENT Configuration -->
      <ng-container *ngIf="moduleConfigContext.module.type === 'ASSIGNMENT'">
        <div class="form-row">
          <div class="form-group">
            <label>üìÖ Deadline (ng√†y)</label>
            <input type="number" [(ngModel)]="moduleConfigContext.module.assignmentDeadlineDays" placeholder="7" min="1">
          </div>
          <div class="form-group">
            <label>üíØ ƒêi·ªÉm t·ªëi ƒëa</label>
            <input type="number" [(ngModel)]="moduleConfigContext.module.assignmentMaxScore" placeholder="100" min="1">
          </div>
        </div>

        <div class="form-group">
          <div class="form-header">
            <label>‚úÖ Y√™u c·∫ßu</label>
            <button class="add-btn" (click)="addAssignmentRequirement()">+ Th√™m y√™u c·∫ßu</button>
          </div>
          
          <div class="requirements-list">
            <div class="requirement-item" *ngFor="let req of moduleConfigContext.module.assignmentRequirements; let ri = index; trackBy: trackByIndex">
              <input type="text" [(ngModel)]="moduleConfigContext.module.assignmentRequirements![ri]" placeholder="Nh·∫≠p y√™u c·∫ßu...">
              <button class="icon-btn icon-btn--danger" (click)="removeAssignmentRequirement(ri)">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M18 6 6 18M6 6l12 12"/>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Assignment Instructions with AI + Markdown Editor -->
        <div class="form-group markdown-editor-section">
          <div class="form-header">
            <label>üìù H∆∞·ªõng d·∫´n chi ti·∫øt (Markdown)</label>
            <button class="toggle-view-btn" (click)="toggleAssignmentViewMode()">
              <span *ngIf="assignmentViewMode === 'edit'">üëÅÔ∏è Preview</span>
              <span *ngIf="assignmentViewMode === 'preview'">‚úèÔ∏è Edit</span>
            </button>
          </div>

          <!-- AI Chat Input -->
          <div class="ai-chat-input-box">
            <div class="ai-prompt-row">
              <input 
                type="text" 
                [(ngModel)]="assignmentAiPrompt" 
                placeholder="Nh·∫≠p y√™u c·∫ßu ƒë·ªÉ AI t·∫°o h∆∞·ªõng d·∫´n... VD: T·∫°o h∆∞·ªõng d·∫´n n·ªôp b√†i, ti√™u ch√≠ ch·∫•m ƒëi·ªÉm..."
                (keyup.enter)="generateAssignmentInstructionsWithAI()"
                [disabled]="isGeneratingAssignmentInstructions"
              >
              <button 
                class="ai-generate-btn"
                (click)="generateAssignmentInstructionsWithAI()"
                [disabled]="!assignmentAiPrompt?.trim() || isGeneratingAssignmentInstructions"
              >
                <span *ngIf="!isGeneratingAssignmentInstructions">ü§ñ T·∫°o v·ªõi AI</span>
                <span *ngIf="isGeneratingAssignmentInstructions">‚è≥ ƒêang t·∫°o...</span>
              </button>
            </div>
          </div>

          <!-- Edit Mode: Textarea -->
          <div class="markdown-edit-view" *ngIf="assignmentViewMode === 'edit'">
            <textarea 
              [(ngModel)]="moduleConfigContext.module.assignmentInstructions"
              placeholder="Nh·∫≠p n·ªôi dung h∆∞·ªõng d·∫´n b·∫±ng Markdown...

# Ti√™u ƒë·ªÅ
## M·ª•c ti√™u
- ƒêi·ªÉm 1
- ƒêi·ªÉm 2

## Y√™u c·∫ßu
1. Y√™u c·∫ßu 1
2. Y√™u c·∫ßu 2

**In ƒë·∫≠m**, *in nghi√™ng*

```python
# Code m·∫´u
print('Hello')
```"
              rows="12"
            ></textarea>
            <div class="markdown-hint">
              üí° H·ªó tr·ª£ Markdown: # Heading, **bold**, *italic*, - list, ```code```
            </div>
          </div>

          <!-- Preview Mode: Rendered Markdown -->
          <div class="markdown-preview-view" *ngIf="assignmentViewMode === 'preview'">
            <div class="markdown-preview-content" *ngIf="moduleConfigContext.module.assignmentInstructions?.trim(); else noContent">
              <markdown [data]="moduleConfigContext.module.assignmentInstructions"></markdown>
            </div>
            <ng-template #noContent>
              <div class="empty-preview">
                <span>üìÑ</span>
                <p>Ch∆∞a c√≥ n·ªôi dung. D√πng AI ho·∫∑c nh·∫≠p th·ªß c√¥ng ·ªü ch·∫ø ƒë·ªô Edit.</p>
              </div>
            </ng-template>
          </div>
        </div>
      </ng-container>
    </div>

    <div class="modal__footer">
      <button class="btn btn--secondary" (click)="onClose()">H·ªßy</button>
      <button class="btn btn--primary" (click)="onSave()">L∆∞u c·∫•u h√¨nh</button>
    </div>
  </div>
</div>
