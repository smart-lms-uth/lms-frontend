<aside class="ai-chat-panel">
  <!-- Chat Header -->
  <div class="ai-chat-panel__header">
    <a routerLink="/teacher-dashboard" class="ai-chat-panel__back-btn">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="m15 18-6-6 6-6"/>
      </svg>
      <span>Quay lại</span>
    </a>
    <div class="ai-chat-panel__title">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 8V4H8"/>
        <rect width="16" height="12" x="4" y="8" rx="2"/>
        <path d="M2 14h2"/>
        <path d="M20 14h2"/>
        <path d="M15 13v2"/>
        <path d="M9 13v2"/>
      </svg>
      <span>AI Assistant</span>
    </div>
  </div>

  <!-- Mode Selector -->
  <div class="ai-chat-panel__mode-selector">
    <button 
      *ngFor="let mode of modeOptions"
      class="ai-chat-panel__mode-btn"
      [class.ai-chat-panel__mode-btn--active]="currentMode === mode.id"
      (click)="selectMode(mode.id)"
      [title]="mode.description">
      <span class="ai-chat-panel__mode-icon">{{ mode.icon }}</span>
      <span class="ai-chat-panel__mode-label">{{ mode.label }}</span>
    </button>
  </div>

  <button class="ai-chat-panel__new-chat" (click)="onClearChat()">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 5v14M5 12h14"/>
    </svg>
    <span>Cuộc trò chuyện mới</span>
  </button>

  <div class="ai-chat-panel__messages" #messagesContainer>
    <div class="ai-chat-panel__welcome" *ngIf="messages.length === 0">
      <div class="ai-chat-panel__welcome-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 8V4H8"/>
          <rect width="16" height="12" x="4" y="8" rx="2"/>
          <path d="M2 14h2"/>
          <path d="M20 14h2"/>
          <path d="M15 13v2"/>
          <path d="M9 13v2"/>
        </svg>
      </div>
      <h2>AI Assistant</h2>
      <p>Chọn chế độ phía trên và bắt đầu trò chuyện với AI.</p>
      
      <div class="ai-chat-panel__mode-info">
        <span>Chế độ hiện tại: <strong>{{ getCurrentModeLabel() }}</strong></span>
      </div>
      
      <div class="ai-chat-panel__suggestions">
        <button 
          *ngFor="let q of suggestedQuestions" 
          class="ai-chat-panel__suggestion"
          (click)="askSuggestedQuestion(q)">
          <span class="ai-chat-panel__suggestion-icon">{{ q.icon }}</span>
          <span>{{ q.text }}</span>
        </button>
      </div>
    </div>

    <div 
      *ngFor="let message of messages; trackBy: trackByMessageId" 
      class="ai-chat-panel__message"
      [class.ai-chat-panel__message--user]="message.role === 'user'"
      [class.ai-chat-panel__message--assistant]="message.role === 'assistant'">
      
      <div class="ai-chat-panel__message-avatar">
        <svg *ngIf="message.role === 'user'" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
          <circle cx="12" cy="7" r="4"/>
        </svg>
        <svg *ngIf="message.role === 'assistant'" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 8V4H8"/>
          <rect width="16" height="12" x="4" y="8" rx="2"/>
          <path d="M2 14h2"/>
          <path d="M20 14h2"/>
          <path d="M15 13v2"/>
          <path d="M9 13v2"/>
        </svg>
      </div>

      <div class="ai-chat-panel__message-content">
        <div class="ai-chat-panel__typing" *ngIf="message.isTyping">
          <span></span>
          <span></span>
          <span></span>
        </div>

        <div class="ai-chat-panel__message-text" *ngIf="!message.isTyping" [innerHTML]="message.content | markdown"></div>
        
        <button 
          *ngIf="!message.isTyping && message.role === 'assistant' && hasPreview(message)"
          class="ai-chat-panel__preview-btn"
          (click)="onOpenPreview(message)">
          <span class="ai-chat-panel__preview-btn-icon">{{ getPreviewIcon(message.previewType!) }}</span>
          <span>{{ getPreviewLabel(message.previewType!) }}</span>
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
            <polyline points="15 3 21 3 21 9"/>
            <line x1="10" y1="14" x2="21" y2="3"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <div class="ai-chat-panel__input-area">
    <div class="ai-chat-panel__current-mode">
      <span class="ai-chat-panel__current-mode-badge">{{ getCurrentModeLabel() }}</span>
    </div>

    <div class="ai-chat-panel__file-preview" *ngIf="selectedFile">
      <div class="ai-chat-panel__file-info">
        <span class="ai-chat-panel__file-icon" [attr.data-type]="getFileIcon(selectedFile)">
          <svg *ngIf="getFileIcon(selectedFile) === 'pdf'" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><path d="M9 15h6"/><path d="M9 11h6"/>
          </svg>
          <svg *ngIf="getFileIcon(selectedFile) === 'image'" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
          </svg>
          <svg *ngIf="getFileIcon(selectedFile) === 'audio'" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>
          </svg>
          <svg *ngIf="getFileIcon(selectedFile) === 'video'" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/><path d="m10 8 6 4-6 4V8z"/>
          </svg>
          <svg *ngIf="getFileIcon(selectedFile) === 'file'" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/>
          </svg>
        </span>
        <div class="ai-chat-panel__file-details">
          <span class="ai-chat-panel__file-name">{{ selectedFile.name }}</span>
          <span class="ai-chat-panel__file-size">{{ formatFileSize(selectedFile.size) }}</span>
        </div>
      </div>
      <button class="ai-chat-panel__file-remove" (click)="removeSelectedFile()" title="Xóa file">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    
    <div class="ai-chat-panel__input-container">
      <input 
        type="file" 
        #fileInput 
        (change)="onFileSelected($event)"
        accept=".pdf,.txt,.jpg,.jpeg,.png,.gif,.webp,.mp3,.wav,.mp4,.mov,.webm"
        style="display: none;">
      
      <button 
        class="ai-chat-panel__attach-btn" 
        (click)="triggerFileInput()"
        [disabled]="isLoading"
        title="Đính kèm file (PDF, ảnh, audio, video)">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
        </svg>
      </button>
      
      <textarea
        #messageInput
        class="ai-chat-panel__input"
        [(ngModel)]="inputMessage"
        (keydown)="onKeyDown($event)"
        [placeholder]="selectedFile ? 'Nhập câu hỏi về file...' : getCurrentPlaceholder()"
        rows="1"
        [disabled]="isLoading">
      </textarea>
      
      <button 
        class="ai-chat-panel__send-btn" 
        [disabled]="(!inputMessage.trim() && !selectedFile) || isLoading"
        (click)="onSendMessage()">
        <svg *ngIf="!isLoading" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="m22 2-7 20-4-9-9-4Z"/>
          <path d="M22 2 11 13"/>
        </svg>
        <div *ngIf="isLoading" class="ai-chat-panel__spinner"></div>
      </button>
    </div>
  </div>
</aside>
