<div class="ai-chat">
  <!-- Sidebar -->
  <aside class="ai-chat__sidebar">
    <div class="ai-chat__sidebar-header">
      <a routerLink="/dashboard" class="ai-chat__back-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="m15 18-6-6 6-6"/>
        </svg>
        <span>Quay lại</span>
      </a>
    </div>

    <button class="ai-chat__new-chat" (click)="clearChat()">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 5v14M5 12h14"/>
      </svg>
      <span>Cuộc trò chuyện mới</span>
    </button>

    <!-- Course Selector Button -->
    <div class="ai-chat__course-selector">
      <label class="ai-chat__course-label">Ngữ cảnh khóa học</label>
      <button 
        class="ai-chat__course-btn"
        [class.ai-chat__course-btn--selected]="selectedCourse"
        (click)="openCourseSelector()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/>
        </svg>
        <span *ngIf="!selectedCourse">Chọn khóa học...</span>
        <span *ngIf="selectedCourse" class="ai-chat__course-selected-name">
          {{ selectedCourse.subjectName }}
        </span>
      </button>
      <div class="ai-chat__course-info" *ngIf="selectedCourse">
        <span class="ai-chat__course-code">{{ selectedCourse.courseCode }}</span>
        <span class="ai-chat__course-semester">{{ selectedCourse.semesterCode }}</span>
        <button class="ai-chat__course-clear" (click)="clearCourseSelection()" title="Bỏ chọn">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 6 6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="ai-chat__history">
      <h3 class="ai-chat__history-title">Lịch sử chat</h3>
      <div class="ai-chat__history-empty">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
        <p>Chưa có cuộc trò chuyện nào</p>
      </div>
    </div>

    <div class="ai-chat__sidebar-footer">
      <div class="ai-chat__model-info">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 8V4H8"/>
          <rect width="16" height="12" x="4" y="8" rx="2"/>
          <path d="M2 14h2"/>
          <path d="M20 14h2"/>
          <path d="M15 13v2"/>
          <path d="M9 13v2"/>
        </svg>
        <span>LMS AI Assistant</span>
      </div>
    </div>
  </aside>

  <!-- Main Chat Area -->
  <main class="ai-chat__main">
    <!-- Welcome Screen (when no messages) -->
    <div class="ai-chat__welcome" *ngIf="messages.length === 0">
      <div class="ai-chat__welcome-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 8V4H8"/>
          <rect width="16" height="12" x="4" y="8" rx="2"/>
          <path d="M2 14h2"/>
          <path d="M20 14h2"/>
          <path d="M15 13v2"/>
          <path d="M9 13v2"/>
        </svg>
      </div>
      <h1 class="ai-chat__welcome-title">Xin chào! Tôi là AI Assistant</h1>
      <p class="ai-chat__welcome-subtitle">
        Tôi có thể giúp bạn giải đáp thắc mắc về bài học, debug code, 
        giải thích khái niệm và nhiều hơn nữa.
      </p>

      <div class="ai-chat__suggestions">
        <h3>Thử hỏi tôi về:</h3>
        <div class="ai-chat__suggestions-grid">
          <button 
            *ngFor="let q of suggestedQuestions" 
            class="ai-chat__suggestion-card"
            (click)="askSuggestedQuestion(q.text)">
            <span class="ai-chat__suggestion-icon">{{ q.icon }}</span>
            <span class="ai-chat__suggestion-text">{{ q.text }}</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Messages Area -->
    <div class="ai-chat__messages" #messagesContainer *ngIf="messages.length > 0">
      <div 
        *ngFor="let message of messages; trackBy: trackByMessageId" 
        class="ai-chat__message"
        [class.ai-chat__message--user]="message.role === 'user'"
        [class.ai-chat__message--assistant]="message.role === 'assistant'">
        
        <!-- Avatar -->
        <div class="ai-chat__message-avatar">
          <ng-container *ngIf="message.role === 'user'">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
          </ng-container>
          <ng-container *ngIf="message.role === 'assistant'">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 8V4H8"/>
              <rect width="16" height="12" x="4" y="8" rx="2"/>
              <path d="M2 14h2"/>
              <path d="M20 14h2"/>
              <path d="M15 13v2"/>
              <path d="M9 13v2"/>
            </svg>
          </ng-container>
        </div>

        <!-- Content -->
        <div class="ai-chat__message-content">
          <!-- Typing Indicator -->
          <div class="ai-chat__typing" *ngIf="message.isTyping">
            <span></span>
            <span></span>
            <span></span>
          </div>

          <!-- Message Text -->
          <div class="ai-chat__message-text" *ngIf="!message.isTyping" [innerHTML]="message.content | markdown"></div>

          <!-- Message Actions -->
          <div class="ai-chat__message-actions" *ngIf="!message.isTyping && message.role === 'assistant'">
            <button class="ai-chat__message-action" title="Sao chép" (click)="copyMessage(message.content)">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
                <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
              </svg>
            </button>
          </div>

          <!-- Timestamp -->
          <span class="ai-chat__message-time">{{ formatTime(message.timestamp) }}</span>
        </div>
      </div>
    </div>

    <!-- Input Area -->
    <div class="ai-chat__input-area">
      <!-- Context indicator -->
      <div class="ai-chat__context-bar" *ngIf="selectedCourse">
        <span class="ai-chat__context-label">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/>
          </svg>
          {{ selectedCourse.subjectName }} ({{ selectedCourse.courseCode }})
        </span>
      </div>
      
      <div class="ai-chat__input-container">
        <textarea
          #messageInput
          class="ai-chat__input"
          [(ngModel)]="inputMessage"
          (keydown)="onKeyDown($event)"
          placeholder="Nhập câu hỏi của bạn..."
          rows="1"
          [disabled]="isLoading">
        </textarea>
        
        <button 
          class="ai-chat__send-btn" 
          [disabled]="!inputMessage.trim() || isLoading"
          (click)="sendMessage()">
          <svg *ngIf="!isLoading" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m22 2-7 20-4-9-9-4Z"/>
            <path d="M22 2 11 13"/>
          </svg>
          <svg *ngIf="isLoading" class="ai-chat__spinner" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
          </svg>
        </button>
      </div>
      <p class="ai-chat__disclaimer">
        AI có thể mắc lỗi. Hãy kiểm tra thông tin quan trọng.
      </p>
    </div>
  </main>
</div>

<!-- Course Selector Modal -->
<div class="modal-overlay" *ngIf="showCourseModal" (click)="closeCourseSelector()">
  <div class="modal-content course-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Chọn khóa học</h2>
      <button class="modal-close" (click)="closeCourseSelector()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 6 6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>
    
    <div class="modal-body">
      <!-- Filters -->
      <div class="course-filters">
        <div class="filter-group">
          <label>Học kỳ</label>
          <select [(ngModel)]="selectedSemesterId">
            <option [ngValue]="null">Tất cả học kỳ</option>
            <option *ngFor="let sem of semesters" [ngValue]="sem.id">
              {{ sem.displayName }}
              <span *ngIf="sem.isCurrent">(Hiện tại)</span>
            </option>
          </select>
        </div>
        
        <div class="filter-group search-group">
          <label>Tìm kiếm</label>
          <input 
            type="text" 
            [(ngModel)]="courseSearchText" 
            placeholder="Tên môn học, mã lớp..."
          />
        </div>
      </div>
      
      <!-- Course List -->
      <div class="course-list" *ngIf="!isLoadingCourses">
        <div 
          *ngFor="let course of filteredCourses" 
          class="course-item"
          [class.course-item--selected]="selectedCourse?.id === course.id"
          (click)="selectCourse(course)">
          <div class="course-item__icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/>
            </svg>
          </div>
          <div class="course-item__info">
            <div class="course-item__name">{{ course.subjectName }}</div>
            <div class="course-item__meta">
              <span class="course-code">{{ course.courseCode }}</span>
              <span class="course-semester">{{ course.semesterCode }}</span>
              <span class="course-status" [class]="'status-' + course.status.toLowerCase()">
                {{ course.status }}
              </span>
            </div>
          </div>
          <div class="course-item__check" *ngIf="selectedCourse?.id === course.id">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
          </div>
        </div>
        
        <div class="course-list__empty" *ngIf="filteredCourses.length === 0">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.3-4.3"/>
          </svg>
          <p>Không tìm thấy khóa học nào</p>
        </div>
      </div>
      
      <!-- Loading -->
      <div class="course-list__loading" *ngIf="isLoadingCourses">
        <div class="spinner"></div>
        <p>Đang tải danh sách khóa học...</p>
      </div>
    </div>
  </div>
</div>
