<div class="live-class-manager">
  <!-- Header with Stats -->
  <div class="lc-header">
    <div class="lc-header__title">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polygon points="23 7 16 12 23 17 23 7"></polygon>
        <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
      </svg>
      <h2>Lớp học trực tuyến</h2>
    </div>
    <button *ngIf="editModeService.editMode()" class="btn btn--primary" (click)="openCreateModal()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 5v14M5 12h14"/>
      </svg>
      Tạo buổi học mới
    </button>
  </div>

  <!-- Stats Cards -->
  <div class="lc-stats">
    <div class="stat-card stat-card--live">
      <div class="stat-card__icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <circle cx="12" cy="12" r="3" fill="currentColor"></circle>
        </svg>
      </div>
      <div class="stat-card__content">
        <span class="stat-card__value">{{ liveCount() }}</span>
        <span class="stat-card__label">Đang phát</span>
      </div>
    </div>
    <div class="stat-card stat-card--upcoming">
      <div class="stat-card__icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
      </div>
      <div class="stat-card__content">
        <span class="stat-card__value">{{ upcomingCount() }}</span>
        <span class="stat-card__label">Sắp diễn ra</span>
      </div>
    </div>
    <div class="stat-card stat-card--completed">
      <div class="stat-card__icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
      </div>
      <div class="stat-card__content">
        <span class="stat-card__value">{{ completedCount() }}</span>
        <span class="stat-card__label">Đã hoàn thành</span>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading()" class="lc-loading">
    <div class="spinner"></div>
    <p>Đang tải...</p>
  </div>

  <!-- Content -->
  <div *ngIf="!loading()" class="lc-content">
    <!-- Live Now Section -->
    <div *ngIf="liveNowClasses().length > 0" class="lc-section lc-section--live">
      <h3 class="lc-section__title">
        <span class="live-indicator"></span>
        Đang diễn ra
      </h3>
      <div class="lc-list">
        <div *ngFor="let liveClass of liveNowClasses()" class="lc-card lc-card--live">
          <div class="lc-card__header">
            <div class="lc-card__status">
              <app-badge variant="success">
                <span class="live-dot"></span>
                LIVE
              </app-badge>
              <span class="lc-card__attendees">{{ liveClass.attendeeCount }} người tham gia</span>
            </div>
            <div class="lc-card__actions" *ngIf="editModeService.editMode()">
              <button class="btn btn--danger btn--sm" (click)="endClass(liveClass)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="6" y="6" width="12" height="12"></rect>
                </svg>
                Kết thúc
              </button>
            </div>
          </div>
          <h4 class="lc-card__title">{{ liveClass.title }}</h4>
          <p class="lc-card__desc" *ngIf="liveClass.description">{{ liveClass.description }}</p>
          <div class="lc-card__meta">
            <span class="meta-item">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              {{ formatDuration(liveClass.duration) }}
            </span>
          </div>
          <div class="lc-card__footer">
            <button class="btn btn--primary" (click)="joinClass(liveClass)">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="23 7 16 12 23 17 23 7"></polygon>
                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
              </svg>
              Vào lớp học
            </button>
            <button class="btn btn--outline btn--sm" (click)="copyMeetLink(liveClass)">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
              Copy link
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Upcoming Section -->
    <div class="lc-section">
      <h3 class="lc-section__title">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        Sắp diễn ra ({{ upcomingCount() }})
      </h3>
      
      <div *ngIf="upcomingClasses().length === 0" class="lc-empty">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        <p>Chưa có buổi học nào được lên lịch</p>
        <button *ngIf="editModeService.editMode()" class="btn btn--primary btn--sm" (click)="openCreateModal()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14M5 12h14"/>
          </svg>
          Tạo buổi học đầu tiên
        </button>
      </div>

      <div class="lc-list" *ngIf="upcomingClasses().length > 0">
        <div *ngFor="let liveClass of upcomingClasses()" class="lc-card">
          <div class="lc-card__header">
            <app-badge [variant]="getStatusBadgeVariant(liveClass.status)">
              {{ getStatusLabel(liveClass.status) }}
            </app-badge>
            <span class="lc-card__countdown" [class.soon]="liveClass.isUpcoming">
              {{ getTimeUntil(liveClass.scheduledAt) }}
            </span>
          </div>
          <h4 class="lc-card__title">{{ liveClass.title }}</h4>
          <p class="lc-card__desc" *ngIf="liveClass.description">{{ liveClass.description }}</p>
          <div class="lc-card__meta">
            <span class="meta-item">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              {{ formatDateTime(liveClass.scheduledAt) }}
            </span>
            <span class="meta-item">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              {{ formatDuration(liveClass.duration) }}
            </span>
            <span class="meta-item">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              Tối đa {{ liveClass.maxParticipants }} người
            </span>
          </div>
          <div class="lc-card__footer" *ngIf="editModeService.editMode()">
            <button class="btn btn--success btn--sm" (click)="startClass(liveClass)" [disabled]="!liveClass.canJoin">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
              </svg>
              Bắt đầu ngay
            </button>
            <button class="btn btn--outline btn--sm" (click)="openEditModal(liveClass)">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
              Sửa
            </button>
            <button class="btn btn--danger-outline btn--sm" (click)="cancelClass(liveClass)">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
              Hủy
            </button>
          </div>
          <div class="lc-card__info" *ngIf="!editModeService.editMode()">
            <div class="meet-link">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
              </svg>
              <span>{{ liveClass.meetLink }}</span>
              <button class="btn-icon" (click)="copyMeetLink(liveClass)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Past Classes Section -->
    <div class="lc-section" *ngIf="pastClasses().length > 0">
      <h3 class="lc-section__title">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
        Đã kết thúc ({{ pastClasses().length }})
      </h3>
      <div class="lc-list lc-list--past">
        <div *ngFor="let liveClass of pastClasses()" class="lc-card lc-card--past">
          <div class="lc-card__header">
            <app-badge [variant]="getStatusBadgeVariant(liveClass.status)">
              {{ getStatusLabel(liveClass.status) }}
            </app-badge>
            <span class="lc-card__attendees" *ngIf="liveClass.status === 'COMPLETED'">
              {{ liveClass.attendeeCount }} người đã tham gia
            </span>
          </div>
          <h4 class="lc-card__title">{{ liveClass.title }}</h4>
          <div class="lc-card__meta">
            <span class="meta-item">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              {{ formatDateTime(liveClass.scheduledAt) }}
            </span>
            <span class="meta-item">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              {{ formatDuration(liveClass.duration) }}
            </span>
          </div>
          <div class="lc-card__footer" *ngIf="editModeService.editMode()">
            <button class="btn btn--outline btn--sm" (click)="openAttendanceModal(liveClass)" *ngIf="liveClass.status === 'COMPLETED'">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
              </svg>
              Xem điểm danh
            </button>
            <button class="btn btn--danger-outline btn--sm" (click)="deleteClass(liveClass)">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              </svg>
              Xóa
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create Modal -->
<div class="modal-overlay" *ngIf="showCreateModal()" (click)="closeCreateModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal__header">
      <h3>Tạo buổi học trực tuyến mới</h3>
      <button class="modal__close" (click)="closeCreateModal()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="modal__body">
      <div class="form-group">
        <label class="form-label">Tiêu đề <span class="required">*</span></label>
        <input type="text" class="form-input" 
               [value]="formData().title"
               (input)="updateFormField('title', $any($event.target).value)"
               placeholder="Ví dụ: Buổi học chương 1 - Giới thiệu">
      </div>
      <div class="form-group">
        <label class="form-label">Mô tả</label>
        <textarea class="form-textarea" rows="3"
                  [value]="formData().description"
                  (input)="updateFormField('description', $any($event.target).value)"
                  placeholder="Mô tả nội dung buổi học..."></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Thời gian bắt đầu <span class="required">*</span></label>
          <input type="datetime-local" class="form-input"
                 [value]="formData().scheduledAt"
                 (input)="updateFormField('scheduledAt', $any($event.target).value)">
        </div>
        <div class="form-group">
          <label class="form-label">Thời lượng (phút)</label>
          <input type="number" class="form-input" min="15" max="480"
                 [value]="formData().duration"
                 (input)="updateFormField('duration', +$any($event.target).value)">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Số người tham gia tối đa</label>
          <input type="number" class="form-input" min="1" max="500"
                 [value]="formData().maxParticipants"
                 (input)="updateFormField('maxParticipants', +$any($event.target).value)">
        </div>
        <div class="form-group form-group--checkbox">
          <label class="checkbox-label">
            <input type="checkbox" 
                   [checked]="formData().recordingEnabled"
                   (change)="updateFormField('recordingEnabled', $any($event.target).checked)">
            <span class="checkbox-text">Cho phép ghi hình</span>
          </label>
        </div>
      </div>
      <div class="form-info">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <span>Link Google Meet sẽ được tự động tạo sau khi lưu.</span>
      </div>
    </div>
    <div class="modal__footer">
      <button class="btn btn--outline" (click)="closeCreateModal()" [disabled]="saving()">Hủy</button>
      <button class="btn btn--primary" (click)="createLiveClass()" [disabled]="saving()">
        <span *ngIf="saving()">Đang tạo...</span>
        <span *ngIf="!saving()">Tạo buổi học</span>
      </button>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" *ngIf="showEditModal()" (click)="closeEditModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal__header">
      <h3>Chỉnh sửa buổi học</h3>
      <button class="modal__close" (click)="closeEditModal()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="modal__body">
      <div class="form-group">
        <label class="form-label">Tiêu đề <span class="required">*</span></label>
        <input type="text" class="form-input" 
               [value]="formData().title"
               (input)="updateFormField('title', $any($event.target).value)">
      </div>
      <div class="form-group">
        <label class="form-label">Mô tả</label>
        <textarea class="form-textarea" rows="3"
                  [value]="formData().description"
                  (input)="updateFormField('description', $any($event.target).value)"></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Thời gian bắt đầu</label>
          <input type="datetime-local" class="form-input"
                 [value]="formData().scheduledAt"
                 (input)="updateFormField('scheduledAt', $any($event.target).value)">
        </div>
        <div class="form-group">
          <label class="form-label">Thời lượng (phút)</label>
          <input type="number" class="form-input" min="15" max="480"
                 [value]="formData().duration"
                 (input)="updateFormField('duration', +$any($event.target).value)">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Số người tham gia tối đa</label>
          <input type="number" class="form-input" min="1" max="500"
                 [value]="formData().maxParticipants"
                 (input)="updateFormField('maxParticipants', +$any($event.target).value)">
        </div>
        <div class="form-group form-group--checkbox">
          <label class="checkbox-label">
            <input type="checkbox" 
                   [checked]="formData().recordingEnabled"
                   (change)="updateFormField('recordingEnabled', $any($event.target).checked)">
            <span class="checkbox-text">Cho phép ghi hình</span>
          </label>
        </div>
      </div>
      <div class="form-info" *ngIf="editingLiveClass()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
          <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
        </svg>
        <span>{{ editingLiveClass()!.meetLink }}</span>
      </div>
    </div>
    <div class="modal__footer">
      <button class="btn btn--outline" (click)="closeEditModal()" [disabled]="saving()">Hủy</button>
      <button class="btn btn--primary" (click)="updateLiveClass()" [disabled]="saving()">
        <span *ngIf="saving()">Đang lưu...</span>
        <span *ngIf="!saving()">Lưu thay đổi</span>
      </button>
    </div>
  </div>
</div>

<!-- Attendance Modal -->
<div class="modal-overlay" *ngIf="showAttendanceModal()" (click)="closeAttendanceModal()">
  <div class="modal modal--lg" (click)="$event.stopPropagation()">
    <div class="modal__header">
      <h3>Điểm danh - {{ viewingAttendance()?.title }}</h3>
      <button class="modal__close" (click)="closeAttendanceModal()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="modal__body">
      <div *ngIf="attendanceLoading()" class="attendance-loading">
        <div class="spinner"></div>
        <p>Đang tải...</p>
      </div>
      
      <div *ngIf="!attendanceLoading() && attendanceList().length === 0" class="attendance-empty">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
        </svg>
        <p>Chưa có ai tham gia buổi học này</p>
      </div>

      <table *ngIf="!attendanceLoading() && attendanceList().length > 0" class="attendance-table">
        <thead>
          <tr>
            <th>STT</th>
            <th>Sinh viên</th>
            <th>Thời gian vào</th>
            <th>Thời gian ra</th>
            <th>Tổng thời gian</th>
            <th>Trạng thái</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let record of attendanceList(); let i = index">
            <td>{{ i + 1 }}</td>
            <td>{{ record.studentName || 'Sinh viên #' + record.studentId }}</td>
            <td>{{ formatDateTime(record.joinedAt) }}</td>
            <td>{{ record.leftAt ? formatDateTime(record.leftAt) : '-' }}</td>
            <td>{{ record.durationMinutes ? formatDuration(record.durationMinutes) : '-' }}</td>
            <td>
              <app-badge [variant]="record.status === 'JOINED' ? 'success' : (record.status === 'LEFT' ? 'warning' : 'danger')">
                {{ record.status === 'JOINED' ? 'Đang tham gia' : (record.status === 'LEFT' ? 'Đã rời' : 'Vắng mặt') }}
              </app-badge>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="modal__footer">
      <button class="btn btn--outline" (click)="closeAttendanceModal()">Đóng</button>
    </div>
  </div>
</div>